# 需求精化工作流 - 快速参考

**文件**：`DevFuncDemandsSpecify_V2.md`
**位置**：步骤1（生成需求文档）之后的可选步骤
**特点**：可选、可迭代、智能分析

---

## 何时使用

- ✅ AI生成的需求文档基本满意，但需要补充细节
- ✅ 需求方向需要调整（如从"个人工具"改为"多用户服务"）
- ✅ 需要增加新的功能点或约束条件
- ✅ 需要调整性能指标或验收标准
- ❌ 完全重写需求（建议重新运行 DevFuncDemandsWrite_V2）

---

## 使用方法

### 基本语法

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "你的补充需求"
```

**重要**：必须使用 `-a` 参数传入补充需求，否则会报错

---

## 常见使用场景

### 场景1：增加新功能

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "增加功能：支持定时自动导入Telegram消息，每天凌晨2点自动运行"
```

**影响章节**：功能需求、技术约束、交付物、验收标准

---

### 场景2：调整需求方向

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "将当前的个人工具改为多用户可复用服务，支持用户注册和权限管理"
```

**影响章节**：几乎所有章节（大幅重写）
**建议**：如果影响太大，AI会建议重新生成

---

### 场景3：增加约束条件

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "增加约束：必须支持离线运行，不依赖外部大模型API"
```

**影响章节**：技术约束、依赖关系

---

### 场景4：修改性能指标

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "性能要求：单次处理至少支持100万条消息，响应时间<10秒"
```

**影响章节**：性能指标、验收标准

---

### 场景5：补充细节

```bash
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "补充数据需求：需要支持导出为CSV和Excel两种格式"
```

**影响章节**：数据需求、交付物

---

## 执行流程

```
1. 加载现有需求文档
   ↓
2. 分析用户输入的影响范围
   ├─ 识别类型（增加功能/调整方向/增加约束/修改指标/补充细节）
   ├─ 确定影响章节
   ├─ 判断影响程度（极高/高/中/低）
   └─ 制定修改策略
   ↓
3. 重新调研（如果需要）
   ├─ 加载项目规范
   ├─ 调研新增技术
   └─ 调研最佳实践
   ↓
4. 更新需求文档
   ├─ 保留不受影响的章节
   ├─ 重写受影响的章节
   ├─ 添加修改标记 <!-- MODIFIED: ... -->
   ├─ 更新文档头部时间戳
   └─ 追加修改历史记录
   ↓
5. 质量门控验证
   ├─ 文档结构完整性
   ├─ 修改标记一致性
   ├─ 业务闭环完整性
   ├─ 交付物与功能一致性
   ├─ 技术约束合规性
   └─ 修改历史完整性
   ↓
6. 输出更新后的文档
```

---

## 输出说明

### 修改标记

在受影响的章节会添加标记：

```markdown
## 2. 核心功能需求

<!-- MODIFIED: 调整为多用户服务架构 -->

### 2.1 用户管理功能（新增）
...
```

### 修改历史

文档末尾会追加修改记录：

```markdown
---

## 修改历史

### 修改记录 #1

**修改时间**：2025-10-11 15:30:00
**修改原因**：将一次性工具改为多用户服务
**影响章节**：第1、2、5、10、11节
**修改摘要**：
- 增加用户认证与权限管理功能
- 增加数据隔离与安全要求
- 更新性能指标，支持并发用户
```

---

## 多次迭代

可以多次运行此步骤，逐步完善需求文档：

```bash
# 第一次：增加多用户支持
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "增加功能：支持多用户"

# 第二次：增加定时任务
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "增加功能：支持定时自动导入"

# 第三次：调整性能指标
codex -p .codex/prompts/DevFuncDemandsSpecify_V2.md -a "性能要求：支持1000并发用户"
```

每次修改都会在"修改历史"中追加新的记录。

---

## 注意事项

### ⚠️ 修改需求后的影响

如果修改了需求文档，已生成的下游文档需要重新生成：

- ❌ 旧的 `DevPlan.md`（开发计划）
- ❌ 旧的 `Tech_Decisions.md`（技术决策）
- ❌ 旧的 `Tasks.md`（任务清单）

**建议操作**：

```bash
# 删除旧文档
rm CodexFeatured/DevPlans/006_*/DevPlan.md
rm CodexFeatured/DevPlans/006_*/Tech_Decisions.md
rm CodexFeatured/DevPlans/006_*/Tasks.md

# 重新生成
codex -p .codex/prompts/DevPlanGeneration_V2.md
codex -p .codex/prompts/TechDecisionsGeneration_V2.md
codex -p .codex/prompts/DevPipelineGeneration_V2.md
```

### ⚠️ 影响程度判断

AI会分析影响程度：

- **极高**：影响≥8个章节，建议重新生成需求文档
- **高**：影响5-7个章节，重写受影响章节
- **中**：影响2-4个章节，更新部分内容
- **低**：影响1个章节，补充具体内容

如果影响程度为"极高"，AI会提示：

```
WARN "检测到重大需求变更，影响程度：极高"
WARN "建议：如需大幅调整需求，建议重新运行 DevFuncDemandsWrite_V2"
```

### ⚠️ Git备份建议

修改前建议备份：

```bash
git add CodexFeatured/DevPlans/006_*/DemandDescription.md
git commit -m "backup: 需求文档精化前备份"
```

修改后提交：

```bash
git add CodexFeatured/DevPlans/006_*/DemandDescription.md
git commit -m "需求精化: 增加多用户支持"
```

---

## 质量门控

每次修改都会经过6项质量检查：

1. ✅ **文档结构完整性**：所有12个章节存在
2. ✅ **修改标记一致性**：受影响章节有标记
3. ✅ **业务闭环完整性**：输入→处理→输出完整
4. ✅ **交付物与功能一致性**：新功能有交付物和验收标准
5. ✅ **技术约束合规性**：符合项目规范
6. ✅ **修改历史完整性**：包含修改时间、原因、摘要

如果验证失败，AI会最多尝试3轮修正。

---

## 与其他工作流的关系

```
DevFuncDemandsWrite_V2 (生成初始需求文档)
    ↓
    ↓ 用户阅读后发现需要调整
    ↓
DevFuncDemandsSpecify_V2 (精化需求文档) ← 可多次迭代
    ↓
    ↓ 需求确定后
    ↓
DevPlanGeneration_V2 (生成开发计划)
    ↓
TechDecisionsGeneration_V2 (生成技术决策)
    ↓
DevPipelineGeneration_V2 (生成任务清单)
    ↓
DevPiplineExcute_V2 (执行开发)
```

---

## 常见问题

### Q1: 是否必须使用此步骤？

**A**: 不是必须的。如果初始需求文档已满足要求，可直接进入步骤2。

### Q2: 可以运行多少次？

**A**: 无限制。可以多次迭代，直到需求文档完全符合预期。

### Q3: 修改会覆盖原文件吗？

**A**: 是的。建议修改前使用Git备份。

### Q4: 如何查看修改了哪些内容？

**A**: 
1. 查看修改标记：`<!-- MODIFIED: ... -->`
2. 查看文档末尾的"修改历史"章节
3. 使用Git查看差异：`git diff`

### Q5: 影响程度"极高"怎么办？

**A**: AI会提示建议重新生成。如果确实需要大幅调整，可以：
- 方案1：继续使用此工具（AI会大幅重写）
- 方案2：重新运行 `DevFuncDemandsWrite_V2`（推荐）

---

**版本**：2.1
**最后更新**：2025-10-11
**相关文档**：
- 完整使用指南：`CodexFeatured/使用指南_V2.md`
- 升级总结：`CodexFeatured/升级总结.md`
- 工作流文件：`.codex/prompts/DevFuncDemandsSpecify_V2.md`

