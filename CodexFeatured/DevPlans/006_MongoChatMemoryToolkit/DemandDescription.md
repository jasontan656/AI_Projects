# 开发需求文档：客户对话数据服务工具

标识信息：INTENT_TITLE_2_4=MongoChatMemoryToolkit；COUNT_3D=006；生成时间=2025-10-15 13:26:05
输出路径（模板）：D:/AI_Projects/CodexFeatured/DevPlans/006_MongoChatMemoryToolkit/DemandDescription.md

## 第1节：项目背景与目标
- 背景说明：现有终端客服机器人需要统一的客户对话资料库与向量化记忆能力，用于支持人工坐席与智能体共享同一份客户历史。
- 目标陈述：构建一套对话数据服务工具，使终端和智能体能够读写历史记录、维护客户画像、查询对话数据（结构化查询和语义检索），实现全程可追溯的客户交流。
- 受众识别：本需求面向后端产品经理、数据治理负责人以及 DevPipelineGeneration 工作流的技术拆解团队。
- 非技术目标：确保客户交流数据在业务层面可整理、可索引、可审计，为智能客服自动化服务提供业务依据。

## 第2节：业务场景分析
- 典型场景一：客户首次咨询接入  
  - 输入：客户在聊天渠道发起首次消息。  
  - 输出：生成新的个人画像草稿，记录首轮对话摘要。  
  - 运行频率：实时，每个新客户触发一次。  
  - 边界设定：不承担意图识别策略，仅记录基础画像。
- 典型场景二：老客户再次咨询  
  - 输入：客户以既有身份再次发送消息。  
  - 输出：根据实时检索结果补充上下文，推送给智能体进行答复。  
  - 运行频率：实时，消息到达即触发。  
  - 边界设定：不修改历史记录，仅追加最新交流。
- 典型场景三：团队复盘客户案例  
  - 输入：客服主管按客户或群组筛选历史记录。  
  - 输出：导出会话主题摘要、画像快照和高价值问答列表。  
  - 运行频率：每日批量或按需。  
  - 边界设定：仅查询，不允许修改原始记录。
- 典型场景四：智能体历史对话检索  
  - 输入：智能体需要查找用户历史提问内容（如"上次问的价格问题"）。  
  - 输出：通过语义搜索聊天记录，返回相关历史对话片段。  
  - 运行频率：按需，当需要回顾历史时触发。  
  - 边界设定：仅检索聊天记录，不涉及业务知识文档读取。

- 触发条件总览：  
  - 需求描述：会话创建、消息追加、复盘查询和历史检索分别由事件流、定时任务以及智能体指令触发。  
  - 补足理由：区分触发源可确保不同角色都能在需要的时间点获取对话数据服务。  
  - 量化指标：实时事件触发延迟≤2秒；计划任务触发偏差≤5分钟；手动查询响应时间符合性能指标。

## 第3节：功能需求描述
- 功能点：个人会话记录归档  
  - 功能描述：对个人渠道的每条客户交流内容建立可检索档案，并与原始消息元数据保持一致。  
  - 业务价值：为后续跟进提供完整上下文，支撑精准问答和投诉追踪。  
  - 覆盖场景：首次咨询、重复咨询、投诉跟踪。  
  - 补足理由：客户体验依赖对历史上下文的完整掌握。  
  - 量化指标：消息写入成功率≥99.5%；单条记录写入确认时间≤1秒。
- 功能点：群组会话记录归档  
  - 功能描述：收集群聊内与客户相关的消息，保留成员身份与时间线，便于后续溯源。  
  - 业务价值：支持团队协作与群体画像分析，减少信息遗漏。  
  - 覆盖场景：群聊客服、活动群维护、专家答疑。  
  - 补足理由：群聊内容常包含决策信息，必须集中管理。  
  - 量化指标：群聊消息入库覆盖率≥98%；线索提取延迟≤3秒。
- 功能点：客户与群组画像维护  
  - 功能描述：持续更新个人与群组的画像档案，包括身份标签、沟通偏好、意向等级。  
  - 业务价值：提高智能体对客户需求的匹配能力，支持营销分层。  
  - 覆盖场景：话术个性化、客户分级、复盘分析。  
  - 补足理由：画像是智能化服务的基础资产。  
  - 量化指标：画像字段完备率≥95%；画像更新延迟≤10秒。
- 功能点：历史对话结构化查询  
  - 功能描述：提供按用户、群组、时间范围等条件查询聊天记录的接口。通过MongoDB结构化查询，主要供人工客服、管理人员查看、审计和复盘使用。  
  - 业务价值：支持客服团队回顾客户历史、生成沟通报告、进行案例分析。  
  - 覆盖场景：客服复盘、投诉追踪、管理报表、数据审计。  
  - 补足理由：人工操作需要完整、准确的历史记录查询能力。  
  - 量化指标：查询响应时间≤500毫秒；支持复杂条件组合查询；数据准确率100%。
- 功能点：历史对话语义检索（AI专用）  
  - 功能描述：对聊天记录执行语义搜索，返回语义相关的对话片段供智能体参考。使用向量数据库（Chroma）检索，按相似度排序返回最相关的对话，无视时间先后。客户提问天马行空时，AI通过语义匹配找到真正相关的历史内容。  
  - 业务价值：快速定位语义相关的历史对话，即使客户换了表述方式也能找到相关内容，大幅提升问题解决效率。  
  - 覆盖场景：用户提及"上次问的那个问题"但表述不同、模糊回忆某个话题、客户用新说法询问老问题。  
  - 补足理由：客户问题表述随意且不连贯，最近几条消息往往无关，必须通过语义匹配在全部历史中找到真正相关的对话。时间顺序对AI无意义，相关性才是关键。  
  - 量化指标：语义匹配相关性评分≥0.75；检索结果有效率≥65%；检索响应时间≤1秒；返回结果按相似度排序。

## 第4节：数据需求描述

### 数据存储架构说明
本工具采用三层存储架构，平衡性能、成本与可靠性：

**第一层：Redis会话缓存（热数据）**
- 用途：缓存活跃会话的最近对话，供AI快速读取上下文。
- 数据组织：按chat_id组织，key格式为 `context:{chat_id}`，存储最近N条消息。
- TTL策略：5分钟无活动自动过期，过期后批量刷入MongoDB和ChromaDB。
- 性能指标：读写延迟≤10毫秒。

**第二层：MongoDB持久化存储（主存储）**
- 用途：存储全部聊天记录原始数据，供人工查询、审计和Redis缓存重建。
- 写入时机：Redis会话过期时批量写入，或手动触发立即写入。
- 恢复机制：Redis缓存缺失时，从MongoDB加载最近N条消息重建缓存。
- 性能指标：批量写入延迟≤1秒；查询响应≤500毫秒。

**第三层：ChromaDB向量存储（语义检索）**
- 用途：存储聊天记录的语义向量，供AI按相似度检索历史相关对话。
- 写入时机：与MongoDB同步批量写入，异步向量化处理。
- 查询场景：当Redis上下文不足以回答（话题跳转、提及历史）时，AI通过Function Call主动查询。
- 性能指标：向量化延迟≤5秒；语义检索响应≤1秒。

**数据流转示例**：
```
新消息 → Redis缓存 → 5分钟无活动 → 批量写入MongoDB + ChromaDB
AI查询 → 先查Redis → 缺失时从MongoDB加载 → 话题跳转时查ChromaDB
```

- 数据主题：个人聊天记录档案（business alias: telegram_individual_chat_history）  
  - 需求描述：记录客户身份标识、消息内容、时间戳、渠道来源、服务人员信息。存储于MongoDB（主存储）和ChromaDB（向量索引），Redis仅作临时缓存。  
  - 补足理由：确保可追溯性并为个体画像更新提供原始素材。三层架构平衡实时性、成本与可靠性。  
  - 量化指标：单日新增消息上限 50,000 条；MongoDB数据留存至少 365 天；Redis缓存命中率≥80%；批量写入成功率≥99.5%。
- 数据主题：群组聊天记录档案（business alias: telegram_group_chat_history）  
  - 需求描述：保存群组标识、成员角色、消息体、关键信息标签。存储架构与个人聊天记录相同（Redis缓存 + MongoDB持久化 + ChromaDB向量索引）。  
  - 补足理由：支持群体行为洞察及群组画像构建。  
  - 量化指标：单群平均日消息 2,000 条，峰值 10,000 条；MongoDB留存周期永久；Redis缓存策略与个人聊天一致。
- 数据主题：客户画像档案（business alias: user_profile）  
  - 需求描述：维护客户基本属性、偏好标签、意向评分、最近互动摘要。  
  - 补足理由：为智能体选择个性化策略提供依据。  
  - 量化指标：画像字段覆盖≥20 个关键属性；更新延迟≤10 秒。
- 数据主题：群组画像档案（business alias: group_profile）  
  - 需求描述：存储群组主题、成员结构、互动热度、关键事件。  
  - 补足理由：帮助业务识别高价值群组并制定运营策略。  
  - 量化指标：群组画像刷新频率≥每日 1 次；关键指标完整率≥90%。
- 数据主题：聊天记录向量索引  
  - 需求描述：将聊天消息生成语义向量并存储到向量数据库（Chroma），支持语义检索历史对话。向量数据组织方式如下：
    - Collection组织：创建2个独立collection（`telegram_individual_chat`、`telegram_group_chat`），按业务类型物理隔离。
    - Metadata标识：每条向量记录必须包含完整metadata（user_id、chat_id、message_id、timestamp等），用于查询过滤。
    - 数据隔离与查询规则：
      * 个人聊天：通过 `where={"user_id": 123}` 过滤，只返回该用户的历史对话。
      * 群组聊天：通过 `where={"chat_id": 456}` 过滤，返回该群所有成员的历史发言，用于理解群内整体讨论内容。
      * 所有同类数据存储在同一collection中通过metadata区分实例，确保数据不串。
    - ID规范：向量ID格式为 `{type}_{chat_id}_{message_id}`，确保全局唯一且可追溯到MongoDB原始记录。
  - 补足理由：结构化查询无法满足模糊语义检索需求，向量检索能更好理解用户意图。采用collection分类+metadata过滤方案避免collection数量爆炸和管理复杂度。  
  - 量化指标：向量化延迟≤5秒；索引更新实时触发；检索响应时间≤1秒；metadata过滤准确率100%（不允许数据串）。
- 数据主题：业务知识文档（可选向量化）  
  - 需求描述：业务文档以MD/YAML格式存储在文件系统，智能体直接读取原始文件。可选地将文档向量化到独立collection（`business_docs`）用于试验性语义检索。  
  - 补足理由：业务文档是结构化内容，直接读取更准确；向量化作为辅助手段可试验效果。若启用向量化，必须与聊天记录collection完全隔离，避免业务知识与用户对话混淆。  
  - 量化指标：文档读取延迟≤500毫秒；向量化（若启用）延迟≤10秒；两种方式对比测试后决定是否保留向量化；若保留，检索时需明确指定collection避免误查。

## 第5节：性能与质量要求
- 性能指标一  
  - 需求描述：Redis写入响应时间不超过 20 毫秒，批量刷入MongoDB的延迟不超过 1 秒，向量化处理延迟不超过 5 秒。  
  - 补足理由：客服对话需无感记录，Redis快速写入保证实时性，批量刷入保证可靠性。  
  - 量化指标：Redis写入P95≤20ms；批量写入MongoDB P95≤1秒；向量化完成时间≤5秒；单节点峰值吞吐≥500次Redis写入/秒。
- 性能指标二  
  - 需求描述：历史对话语义检索接口在并发 100 次查询时平均响应时间不超过 1.5 秒。  
  - 补足理由：智能体在高峰期必须快速获取历史对话上下文。  
  - 量化指标：并发 100 时平均响应≤1.5 秒；成功率≥99%。
- 质量指标一  
  - 需求描述：聊天记录与画像之间的关联准确率达到 98% 以上。  
  - 补足理由：错误关联会导致误判客户意向。  
  - 量化指标：人工抽检关联准确率≥98%；错配率≤2%。  
- 质量指标二  
  - 需求描述：历史对话语义检索结果准确性需达到 70% 以上。  
  - 补足理由：语义检索结果直接影响智能体对历史上下文的理解。  
  - 量化指标：人工抽检检索准确率≥70%；用户反馈相关性得分≥3.8/5。

## 第6节：异常场景与边界条件
- 异常场景一  
  - 需求描述：当Redis写入失败时需记录失败明细并立即重试；批量刷入MongoDB/ChromaDB失败时需在 3 分钟内重试。Redis异常时降级为直接写MongoDB。  
  - 补足理由：保障资料库完整性，避免对话断档。Redis故障不应影响数据持久化。  
  - 量化指标：Redis重试成功率≥99%；批量刷入重试成功率≥95%；最大重试次数 3 次；Redis降级模式响应时间≤500ms。  
- 异常场景二  
  - 需求描述：向量检索超时需返回降级提示，回退到结构化查询（按时间/用户ID查询最近对话）。  
  - 补足理由：确保智能体不会因向量检索失败而中断服务。  
  - 量化指标：降级响应时间≤2 秒；超时率≤1%；降级查询成功率≥98%。  
- 异常场景三  
  - 需求描述：当画像字段缺失或冲突时需触发任务补齐并记录审计。  
  - 补足理由：画像质量直接影响业务决策。  
  - 量化指标：补齐任务在 30 分钟内完成≥95%；冲突记录全量存档。

## 第7节：安全与合规要求
- 安全要求一  
  - 需求描述：所有客户资料访问需基于角色授权，并记录访问主体、目的与时间。  
  - 补足理由：客户数据属于敏感信息，必须可追踪。  
  - 量化指标：访问审计日志实时写入率 100%；未授权访问阻断率 100%。  
- 安全要求二  
  - 需求描述：对话内容在持久化前需执行敏感字段脱敏策略。  
  - 补足理由：降低个人信息泄露的合规风险。  
  - 量化指标：脱敏覆盖率≥99%；合规抽检通过率 100%。  
- 安全要求三  
  - 需求描述：画像更新需保留历史版本并支持追溯变更原因。  
  - 补足理由：满足审计与客户回溯需求。  
  - 量化指标：历史版本保存周期≥730 天；版本查询响应≤2 秒。

## 第8节：可观测性要求
- 可观测性项一  
  - 需求描述：记录写入、检索、画像更新等关键事件需生成结构化日志，并标记会话 ID。  
  - 补足理由：便于定位问题与衡量流程效率。  
  - 量化指标：关键事件日志覆盖率 100%；日志查询延迟≤5 秒。  
- 可观测性项二  
  - 需求描述：监控业务指标，包括每日消息量、检索命中率、画像更新次数。  
  - 补足理由：帮助业务判断运营效果与容量需求。  
  - 量化指标：指标更新间隔≤5 分钟；仪表板可用率≥99%。  
- 可观测性项三  
  - 需求描述：对外提供周报模板，归纳服务水平指标与异常处置情况。  
  - 补足理由：确保管理层获得透明汇报。  
  - 量化指标：周报每周固定时间发布；延迟率≤5%。

## 第9节：范围与非目标
- 范围说明：  
  - 包含对客户聊天记录、群组记录、客户画像、群组画像的读写能力（MongoDB）。  
  - 包含聊天记录的向量化与语义检索能力（向量数据库）。  
  - 可选地支持业务文档向量化试验（独立集合），与原始文档读取对比效果。  
  - 包含客服复盘、智能体历史检索、数据审计等业务使用场景。
- 非目标：  
  - 不负责业务知识文档的生成、编辑或管理（文档由业务团队维护）。  
  - 不提供业务知识文档的读取功能（AI直接读取文件系统中的MD/YAML文件）。  
  - 不提供聊天渠道接入与消息发送能力（由Telegram Bot模块负责）。  
  - 不落实具体模型调用策略或对话流程编排（由智能体编排模块负责）。  
  - 不交付分析报表的前端展示（仅提供数据查询API）。

## 第10节：项目约束说明
- 运行约束：需部署在现有后端服务体系中，遵守《Backend Constitution》要求的异步执行模式与 FastAPI 应用入口。  
- 数据接入约束：Redis（REDIS_URL）、MongoDB（MONGODB_URI）、向量数据库（CHROMADB_URL）连接参数取自统一环境变量管理，不得写死在业务逻辑中。  
- 任务编排约束：向量化等批量处理需通过既有任务编排体系调度，符合"所有业务任务必须经由调度中心"强制条款。  
- 日志约束：必须复用 RichLogger 体系，禁止引入额外日志框架。  
- 向量检索约束：聊天记录向量化使用 Chroma 向量数据库，遵守 LangChain/LangGraph 优先策略。Collection组织方式：
  - 必须创建独立collection按业务类型隔离（个人聊天、群组聊天、业务文档各一个）。
  - 禁止为每个用户/群组创建独立collection，必须通过metadata字段区分实例。
  - 查询时必须带上metadata过滤条件，确保数据不串。
  - 业务文档向量化（若启用）使用独立collection（business_docs）与聊天记录完全隔离。  
- 文档读取约束：智能体读取业务文档时直接访问文件系统（/business_docs/），不通过本工具集。向量化仅作为辅助试验功能。  
- 安全约束：密钥与敏感配置需依赖集中密钥管理，遵守最小权限策略。

## 第11节：交付与验收标准
- 交付物清单：需求文档（含业务流程图示建议）、数据字典、事件与指标定义表、验收方案。  
- 验收清单：  
  - 功能验收：依据功能点逐项验证读写、检索、画像维护能力是否满足指标。  
  - 数据验收：核对数据主题字段完整性与留存策略。  
  - 性能与质量验收：完成并发写入与检索抽测，达成量化阈值。  
  - 安全与审计验收：验证授权、脱敏、历史版本留存机制。  
  - 可观测性验收：确认日志、指标、周报全部上线。  
  - 文档验收：确保所有交付文档齐备并通过评审。
