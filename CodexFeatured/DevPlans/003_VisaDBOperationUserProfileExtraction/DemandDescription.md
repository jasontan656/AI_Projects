# VisaDB 用户画像字段识别与文档化需求说明

## 背景与目标

- 背景：现有数据库转储文件 `D:/AI_Projects/Visa/visa_db.sql` 中包含大量与客户及其家庭画像相关的信息字段（示例：地址、电话、邮箱、身高、体重、证件号码等）。需要一套工具从业务视角盘点并标注“与用户画像相关”的字段，输出可审计、可复用的文档结果，以支撑后续治理与最小化数据使用原则。
- 目标：面向业务使用者，提供一键化流程：
  - 自动遍历数据源并采样代表性值，辅助判定字段是否“与用户画像相关”；
  - 自动生成结构化结果与审计说明；
  - 以“安全、合规、可追溯”为底线，避免将敏感数据泄露到日志或外部系统。

## 术语与范围

- “用户画像相关字段”：用于直接或间接描绘个人/家庭背景与个人信息的字段。
- 判定分类：`True`（确定相关）、`需审核`（不确定/边界情形）、`False`（无关）。
- 工具定位：离线分析辅助，不涉及对原数据库写入或业务接口改造；一次性使用的小工具，获得目标输出后无需长期运行与运维。

## 功能需求

1) 数据源读取
- 输入：路径固定为 `D:/AI_Projects/Visa/visa_db.sql`（本地 SQL 转储文件）。
- 行为：自动识别/枚举库内所有表及字段；无需连接真实数据库；不得修改原始文件。
- 约束：仅在 `D:/AI_Projects/Kobe/TempUtility/VisaDBOperation` 代码库目录内工作与输出。

2) 字段采样与代表性值提取
- 行为：对每个字段从原始样本中提取“按值长度排序的 Top10 代表性值”。
- 约束：
  - 采样值用于辅助判定，不在日志中明文输出；
  - 采样结果写入一个中间 JSON 文件（仅本地存储，供后续判定步骤读取）。

3) 字段相关性判定（LLM 辅助）
- 行为：对“每个字段 + 其 Top10 值”交由大模型进行语义判断，输出三类结论之一：`True`/`需审核`/`False`。
- 交互约束：
  - 使用 LangChain 进行 API 封装与流式 I/O；
  - 可配置的模型与密钥来源于D:/AI_Projects/Kobe/.env；
  - 单次请求仅携带必要最小数据；对可能包含敏感信息的样本应进行脱敏（如掩码中间段）。
- 结果说明：为每个字段生成 30–50 字的自然语言判定理由（中文，避免术语）。

4) 并发执行与有序落盘
- 并发：支持“最多 10 个并发工作单元”执行字段判定；当字段量大时应批次化处理。
- 有序写入：采用“队列消息制”汇总判定结果，确保向目标 Markdown 文档按分类与字段名稳定顺序插入（从上到下依次为 `True`、`需审核`、`False`）。
- 进度：提供整体进度与当前批次统计（不暴露敏感样本值）。

5) 输出产物
- 中间文件：`field_samples.json`（每字段 Top10 代表性值，脱敏存储）。
- 最终文档：`D:/AI_Projects/Kobe/TempUtility/VisaDBOperation/DatabaseDietPlan.md`
  - 结构要求：
    - 概览：字段总数、判定分布（True/需审核/False 数量）
    - 详细清单（按分类分组，自上而下 True→需审核→False）：
      - 每个字段：字段标识（表.字段）、简要中文释义（如可推断）、判定结论、30–50 字理由。
  - 可追溯性：写明本次分析时间、所用模型标识与版本、采样策略摘要（不含明文样本）。

6) 配置与可控项
- 路径：允许覆盖输入 SQL 文件路径与输出目录（默认如上）。
- 并发：最大并发度（默认 10）。
- LLM：供应商、模型名、重试策略等（以环境变量/配置文件注入）。
- 脱敏：启用/禁用、掩码策略（如邮箱/手机号/证件号等规则）。
- 断点/日志：`RESUME_ENABLED`（默认开启）、`STATE_FILE`（默认 `runs/state/resume_state.json`）、`LOG_FILE`（默认 `runs/logs/tool.log`）。

7) 日志与审计（遵循 BackendConstitution）
- 统一使用 `Kobe//SharedUtility//RichLogger`；禁止使用 `print()` 输出业务日志。
- 日志级别：INFO 默认；对外部 API 失败与重试过程记录到 WARN/ERROR。
- 严禁在日志中记录原始敏感值；仅记录字段名、表名、批次号、错误摘要与追踪上下文。

8) 错误处理与重试
- 对 LLM 请求、文件读取与解析错误，提供指数退避重试；超过阈值则降级为“需审核”。
- 出错项需在文档中进行标注，便于后续人工复核。

9) 性能与容量
- 能够在中等规模 SQL 转储上于可接受时间内完成（并发 10 时具线性加速）。
- 内存友好：按批次流式解析与判定，避免一次性将全部样本常驻内存。

10) 安全与合规
- 本地优先：默认仅在本地脱敏后再调用外部 LLM；必要时提供“本地/云端”开关。
- 访问凭证通过环境变量加载，不写入代码与仓库。
- 输出文档不包含任何可还原个人身份的敏感明文。

11) 断点续传（简化）
- 单一状态文件：将“已处理字段集合、当前批次游标、最后成功写入位置”等运行状态写入 `runs/state/resume_state.json`。
- 恢复方式：开启时查询日志并询问是否从状态文件恢复，若断点续传日志文件不存在则从头开始并创建。
- 幂等与去重：恢复后跳过已处理字段；落盘去重，避免重复插入。
- 一次性使用：当产生期望输出后，可提供 `--reset` 选项清空状态文件（或手动删除）。

12) 运行日志（简化）
- 单一日志文件：写入到 `runs/logs/tool.log`，无需多运行归档与轮转。
- 日志内容：启动参数、批次进度、成功/失败计数、错误摘要与重试次数；严禁敏感明文。
- 日志级别：INFO 默认，错误与异常使用 WARN/ERROR；统一使用 `Kobe//SharedUtility//RichLogger`。

13) 生命周期（一次性工具）
- 工具定位为一次性：完成目标文档后可停止使用；默认不引入外部持久化队列或复杂运维组件。
- 可选清理：提供 `--reset` 用于清理 `resume_state.json` 与在日志中写入完成标记，便于归档。

## 与官方/社区最佳实践对齐要点

- 语言与环境：Python 3.10；虚拟环境位于 `Kobe//.venv`。
- 依赖与日志：统一使用 `logging` + Rich 风格化输出（`Kobe//SharedUtility//RichLogger`）。
- LangChain：使用标准 Runnable/回调机制实现流式；遵循供应商 SDK 的重试与超时建议。
- 并发：I/O 密集型（LLM 调用）优先异步/线程池；CPU 密集型（解析/脱敏）分离批次；保持可配置。
- 队列：本地内存队列即可满足当前需求；按一次性工具定位，不默认引入外部队列。

## 建议的目录结构（新增）

```
D:/AI_Projects/Kobe/TempUtility/VisaDBOperation/
├─ docs/
│  ├─ DatabaseDietPlan.md         # 最终判定结果文档（工具生成）
├─ Readme.md                      # 使用说明文档
├─ data/
│  ├─ input/
│  │  └─ visa_db.sql              # 源 SQL 转储（引用路径，非必须复制）
│  └─ samples/
│     └─ field_samples.json       # 字段 Top10 代表性值（脱敏存储）
├─ runs/
│  ├─ logs/
│  │  └─ tool.log                 # 单一运行日志（INFO/WARN/ERROR），一次性工具足够
│  └─ state/
│     └─ resume_state.json        # 断点续传状态（已处理集合、游标等）
├─ cli.py                         # 命令行入口：一键分析、配置加载、进度展示
├─ src/                        
│  ├─ orchestrator.py             # 任务编排：批次划分、并发执行、队列汇总
│  ├─ extractors/
│  │  └─ sql_dump_reader.py       # SQL 解析与表/字段枚举（只读）
│  ├─ sampler/
│  │  └─ value_sampler.py         # Top10 代表性值提取与脱敏
│  ├─ llm/
│  │  └─ judger.py                # 基于 LangChain 的判定封装（True/需审核/False + 理由）
│  ├─ persistence/
│  │  └─ writer.py                # 队列消费并按分类有序写入 Markdown（幂等去重）
│  ├─ concurrency/
│  │  └─ runner.py                # 并发与重试控制（最大并发 10 可配）
│  └─ config/
│     └─ settings.py              # 可配置项（路径、并发、模型、脱敏、断点续传、日志文件）
└─ tests/
   └─ test_sanity.py              # 基础健壮性与回归校验（非敏感数据）
```

放置理由：
- 目录集中于 `Kobe//TempUtility//VisaDBOperation`，完全满足代码库范围约束，便于隔离与维护；
- `docs/` 将产出与规范并置，降低沟通成本；`data/` 明确中间数据与输入来源；`runs/` 保存运行工件（日志+状态）；
- `src/` 以职责拆分，便于替换实现；`tests/` 保留最小可用回归验证，保障重构安全。

## 变更与新增决策

- 新增目录/文件：如上“建议的目录结构”所示，均为新增；
  - 目标：承载本工具源码、配置与结果文档，避免污染其他业务目录；
  - 用途：满足“采样—判定—汇总—文档化—断点续传—运行日志”的端到端流程；
  - 合规：严格遵循 BackendConstitution 中关于 Python 版本、日志、目录范围的约束。
- 修改现有文件：无。
  - 原因：当前仓库未包含该工具的实现，新增独立目录即可完成能力补充，无需修改其他模块。

## 验收标准（面向业务）

- 能在不修改源 SQL 文件的情况下完成字段枚举与采样；
- 生成的 `DatabaseDietPlan.md` 包含概览与分组清单，排序为 True→需审核→False；
- 每个字段具备中文判定理由（30–50 字），可读性强、避免技术术语；
- 日志输出规整、无敏感明文；失败项自动降级为“需审核”并标注；
- 支持并发度可配置（默认 10），总体进度可见；
- 可通过环境变量切换 LLM 供应商与模型；配置项生效无需改代码；
- 中断后使用 `--resume` 能从上次进度继续，且不重复处理/写入已完成字段；
- 存在 `runs/state/resume_state.json` 与 `runs/logs/tool.log` 两项运行工件；
- 多次恢复与重试不导致结果错乱，文档内顺序与分组保持稳定；状态损坏时产生清晰告警并默认不写入敏感明文。

## 补充建议与细化项

- 脱敏策略建议：手机号中间 4 位、邮箱用户名部分、证件号中间段统一掩码；
- 判定提示词模板：以“字段语义 + 脱敏样本 + 业务定义”组织，避免引导性偏差；
- 审计快照：为运行记录元数据（时间、模型、参数、字段数、失败数）写入结果文档页眉，便于回溯；
- 人工复核清单：为“需审核”字段自动汇总到文档顶部，支持二次备注；
- 作为一次性工具，不引入日志轮转和多运行归档；如需长期化再评估引入 RQ/Redis 与日志轮转方案。

