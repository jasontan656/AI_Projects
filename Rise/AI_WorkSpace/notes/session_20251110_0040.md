# Session Notes 2025-11-10 00:40 CST

## User Intent
- 调研 Up 前端最新 DevDoc（Workflow Builder、渠道绑定、可观测性），核实 Rise 后端契约缺口导致前端上线受阻的问题，并给出后端修复方向。

## Repo Context
- `Up/AI_WorkSpace/DevDoc/On/session_20251109_0149_workflow_builder.md`: 前端已实现 Workflow Builder，依赖 `/api/workflows` 列表/CRUD 之外，还要求 `status`, `nodeSequence`, `promptBindings`, `strategy` 字段以及 `/publish`、`/rollback` 接口来管理版本。当前 Rise 后端（`src/interface_entry/http/workflows/routes.py`）仅支持 list/create/update/apply，无发布/回滚路由，`WorkflowDefinition` 也只含 `stage_ids`, `metadata`，未暴露 builder 期望的状态与策略字段。
- `Up/AI_WorkSpace/DevDoc/On/session_20251109_0149_channel_binding.md`: 渠道 Tab 期望 `/api/workflow-channels/{workflowId}` CRUD、`/api/channels/telegram/health`、`/api/channels/telegram/test` 等后端契约，目前在 Rise 代码中 `rg "workflow-channels" -n src` 无命中，说明尚未实现任何 workflow channel API，导致前端无法保存/获取 Telegram 配置。
- `Up/AI_WorkSpace/DevDoc/On/session_20251109_0149_observability.md`: 定义 `/api/workflows/{id}/logs/stream`、`/logs?limit=`、`/variables`、`/tools`。Rise 后端在 `src/interface_entry/http/workflows/routes.py:205-306` 已实现这些接口并接入 `WorkflowObservabilityService`，与前端契约基本对齐，是目前唯一完成的部分。
- Rise 后端 Workflow 领域模型位于 `src/business_service/workflow/models.py`，`WorkflowDefinition` 只包含 `workflow_id/name/description/stage_ids/metadata/version/timestamps`，未提供 status/publish 记录/策略等字段，导致与前端 builder 数据结构完全不匹配。

## Technology Stack
- 前端：Vue 3 + Pinia + Element Plus（从 DevDoc 要求的组件命名如 `WorkflowChannelForm.vue`, `ElMessageBox` 可得）。
- 后端：FastAPI + Pydantic（`interface_entry/http/workflows/routes.py` 使用 `response_model=ApiResponse[...]`）。队列执行堆栈依赖 Redis Streams +自研 `TaskRuntime`（来自 `foundational_service.persist.worker`）。

## Search Results
1. **FastAPI response_model 合同**（Context7 `/fastapi/fastapi` response-model 文档）：强调通过 `response_model` 精确定义返回结构，保障 OpenAPI 契约与验证。当前后端虽然声明了 `WorkflowResponse`，但模型本身缺少前端需求字段，导致契约仍不完整。
2. **API contract 生存指南**（Exa: Evil Martians “API contracts and everything I wish I knew” 2025-07-23）：指出“后端先行”容易让前端猜测数据结构，引发深夜缝补；必须在开发前建立 API contract。此案例正吻合当前情况：前端已根据文档实现功能，但后端没有实现对应契约。

-## Architecture Findings
- **Workflow Builder 契约空缺**：后端缺 publish/rollback 路由及版本/状态字段，无法满足前端 M1 要求，前端调用会 404 或字段缺失。必须扩展 `WorkflowDefinition`（新增 status/nodeSequence/strategy/metadata.promptBindings/publishHistory）并在 HTTP 层实现 `/api/workflows/{id}/publish` / `.../rollback`。否则 builder 的核心流程（发布/回滚、diff）无法落地。
- **渠道绑定全缺失**：Rise 后端完全没有 workflow channel 数据模型与接口，前端 channel Tab（M2）无 API 可用，会一直报 404/未实现。需设计 `WorkflowChannelPolicy` 模型 + `/api/workflow-channels` 路由，支持 Telegram 配置 CRUD、健康、测试，否则“发布→触达用户”闭环缺口严重。
- **可观测性已部分对齐**：日志/变量/工具接口已经实现，但需保证响应结构（telemetry.*, metadata.*）与前端一致，避免再次出现“契约缺字段”的问题。
- **新增细化文档**：`session_20251110_0040_workflow_channel_backend.md` 现已补充数据库迁移策略、Telegram 客户端设计、Redis 频控与测试计划，可作为后续实现的权威文档。

## Defensive Considerations
- 扩展 Workflow schema 与 publish API 时必须遵守 `PROJECT_STRUCTURE`：schema 归 Business Service，HTTP 层仅承载契约；禁止将 publish 逻辑塞进 Interface 层。
- Channel API 需考虑敏感信息（bot token），不可在日志中裸写；同时需设计健康检查超时、测试频控与后端幂等键，避免 Telegram 被滥用。
- 发布/回滚应结合版本冲突处理（409），并提供审计字段 `updatedBy` 供前端展示；对照 DevDoc 的 `status`、`version` 展示需求。

## File References
- `AI_WorkSpace/DevDoc/On/session_20251110_0040_workflow_channel_backend.md`
- `D:\AI_Projects\Up\AI_WorkSpace\DevDoc\On\session_20251109_0149_workflow_builder.md`
- `D:\AI_Projects\Up\AI_WorkSpace\DevDoc\On\session_20251109_0149_channel_binding.md`
- `D:\AI_Projects\Up\AI_WorkSpace\DevDoc\On\session_20251109_0149_observability.md`
- `D:\AI_Projects\Rise\src\business_service\workflow\models.py`
- `D:\AI_Projects\Rise\src\interface_entry\http\workflows\routes.py`
