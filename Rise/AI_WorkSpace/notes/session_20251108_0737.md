# Session Notes 2025-11-08 07:37 CST

## User Intent
- 用户要求验证“兜底队列”是否真的在 Telegram 回复“联系管理员”时仍将消息入队，并在流程配置可用后自动重放；重点核查两个点：1）消息是否入队保存；2）流程就绪后是否顺序处理并回传结果、清理积压。
- 最新补充：即便 workflow 未配置或后端临时宕机，也必须把消息写入兜底层（Redis+RabbitMQ），确保可长期存储（RabbitMQ 按 quorum queue 永久保留）；后端每次启动都要检测依赖可用性，有 backlog 就继续处理，否则必须告警提示“仍有未处理消息，服务不可用”。
- 进一步要求：文档需明确“外部消息解耦”理念——Telegram 等外部输入都要先落为统一的 `TaskEnvelope`，核心字段包含 `channel`、`chatId`、`messageId`、`message` 等结构化数据；Workflow 只是后端消费时的附加信息，不能决定消息是否入队。后端各渠道使用异步轮询（“敲门”）机制按 `channel`/`chatId` 取回并处理，避免入口直接推送。

## Repo Context
- `src/business_service/conversation/service.py:98-193`：`TelegramConversationService.process_update` 只有在 `_extract_workflow_id` 返回值存在时才构建 `TaskEnvelope` 并调用 `TaskSubmitter.submit()`，缺失 workflow 时直接 `_build_workflow_missing_result`（501-512 行）返回 `status="ignored"`；意味着没有任何 `TaskEnvelope` 被写入 Redis。
- `src/foundational_service/persist/rabbit_bridge.py:1-146`：实现了 `RabbitPublisher`/`RabbitConsumer`，支持将 `TaskEnvelope` 镜像到 RabbitMQ quorum 队列并持久保存，但当前入口 (`process_update`) 并未调用该桥接层，导致“永久保留”尚未落地。
- `src/interface_entry/telegram/handlers.py:200-262`：handler 发现 `ConversationServiceResult.status == "ignored"` 且 `error_hint == "workflow_missing"` 时，仅同步发送“未找到流程，请联系管理员”，没有追加任何排队或补偿逻辑。
- `src/foundational_service/persist/redis_queue.py:41-88`：`RedisTaskQueue.enqueue()` 将任务写入 `queue:tasks` Stream 并持久化 payload，证明一旦 `TaskSubmitter` 被调用，消息便留存在 Redis。
- `src/foundational_service/persist/worker.py:166-338`：`TaskWorker` 轮询 Stream、调用 `WorkflowTaskProcessor`，成功后 `mark_completed` 并通过 `TaskResultBroker.publish()` 通知等待者；`TaskRuntime.start()` 先 healthcheck 再启动 Scheduler 与 Worker，确保恢复时会继续消费积压。
- `src/interface_entry/bootstrap/app.py:478-506`：FastAPI 启动时注入 `set_task_queue_accessors`，同时创建 `RuntimeSupervisor` 监听 redis/rabbit 可用性，确保依赖可用时自动 `runtime.start()`。
- `src/interface_entry/runtime/supervisors.py:82-145`：`RuntimeSupervisor` 在能力恢复时 `await runtime.start()`，若依赖降级则停用 runtime，这就是“后端启动有信号告知可用”所在。
- `var/logs/current.log`（2025-11-07T23:25Z 档）仅出现 `task_worker.start/stop`，未见 `telegram.queue.enqueued`，印证运行期间没有消息成功入队。

## Technology Stack
- 入口：aiogram Telegram Bot + FastAPI。
- 队列：Redis Streams（`queue:*` namespace）+ retry scheduler + RabbitMQ capability gating。
- 存储：MongoDB（workflow 定义 + 运行结果）；配置由 CapabilityRegistry 管理。

## Search Results
- context7 `/aiogram/aiogram`：回顾 aiogram handler/middleware 模式，提示可以通过 outer middleware 注入 logging、错误处理，验证入口应在 handler 层补充兜底逻辑。
- context7 `/rabbitmq/rabbitmq-website`：RabbitMQ 官方文档强调 durable queue + persistent message 才能在 broker 重启后恢复 backlog，并通过 QoS/ack 控制消费。
- Exa `redis streams backlog`：文章强调 Redis Streams 通过 XAUTOCLAIM/持久化可用作可靠任务队列，为“消息入队等待 worker 恢复”提供依据。
- Exa `cloudamqp 13 common mistakes`：列出 RabbitMQ 持久化常见错误，提醒 Publisher Confirm、Prefetch 等配置对 backlog 恢复重要。
- Web 搜索 `turn0search1`：RabbitMQ 官方队列文档，明确 durable + persistent 消息会在节点重启后恢复。
- Web 搜索 `turn0search2`：Relativity 运维文档示例监控 backlog 阈值，提供“队列 backlog 超限”预警思路。
- Web 搜索 `turn0search11`：RabbitMQ 官方博客“Notify me when RabbitMQ has a problem”，列举内建告警（UnroutableMessages、LowDiskWatermark 等），可借鉴为启动自检/运行期告警来源。

## Architecture Findings
- 兜底策略与实现不符：代码在 workflow 缺失时返回 ignored 并立即回复用户，没有触发 `TaskSubmitter`，因此队列里不会保留任何消息，无法满足“流程补齐后自动重试”。
- 虽然 Redis 队列与 Worker 具备积压重放 + RuntimeSupervisor 自动唤醒机制，但这一链路只在 workflow 已知时才会执行，缺少“无流程也入队等待”行为。
- 日志缺乏 `telegram.queue.*` 记录，运维无法验证是否发生入队；应新增 metric/log 以佐证队列运作，并在 workflow 缺失分支明确记录“消息被丢弃”。
- 若用户持续收到“联系管理员”，实际消息已全部丢弃；未来即便配置流程，也没有历史上下文可重播，违背兜底初衷。
- RabbitMQ 桥接未启用：虽然 `rabbit_bridge.py` 已实现 Durable publisher/consumer，但 `TaskRuntime` 目前只依赖 Redis；需决定是否在入口/worker 中镜像任务到 RabbitMQ 以实现“永久保留”。
- 启动自检与 backlog 警告缺失：`RuntimeSupervisor` 只基于 Capability 状态启停 runtime，没有检查 Redis/Rabbit backlog 深度，也没有在“依赖不可用 + backlog>0”时主动发告警，与用户“启动时检测并提示”要求不符。

## File References
- `src/business_service/conversation/service.py:98-193,501-512`
- `src/interface_entry/telegram/handlers.py:200-262`
- `src/foundational_service/persist/redis_queue.py:41-88`
- `src/foundational_service/persist/worker.py:166-338`
- `src/foundational_service/persist/rabbit_bridge.py:1-146`
- `src/interface_entry/bootstrap/app.py:478-506`
- `src/interface_entry/runtime/supervisors.py:82-145`
- `var/logs/current.log`

## Dev Docs
- `AI_WorkSpace/DevDoc/On/session_20251108_0737_telegram_queue_backlog.md` 已更新：新增“统一任务对象（封包+原始载荷）”章节，明确标准字段 + `channelPayload.raw` 双轨存储、示例 JSON、channel worker 的消费职责，并在成功路径/失败模式/验收条目中加入 raw payload、channel router、backlog 阈值等细节。
