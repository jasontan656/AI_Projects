# Session Notes 2025-11-08 01:09 CST

## User Intent
- 用户报告 Telegram 消息“完全不通”，此前还会看到报错，现在完全无返回，且 ngrok 控制台显示 502 Bad Gateway。
- 要求我们查阅最新日志并给出原因。

## Repo Context & Evidence
- `var/logs/current.log:22-24`（2025-11-07T17:06Z）连续记录 `startup.telegram_backlog.unexpected_error` 与 `startup.telegram_backlog.unreachable`，异常栈均为 `ClientConnectorError` 指向 `api.telegram.org:443`，说明服务在尝试注册 webhook 时无法访问 Telegram API。
- 同时 `var/logs/current.log` 中没有任何 webhook 请求或处理日志，意味着应用在启动阶段就停留在 degraded 状态，没有进入正常消息流。
- `Get-NetTCPConnection -LocalPort 8010 -State Listen` 空结果，表明当前并无 uvicorn/FastAPI 进程监听本地 8010 端口，印证 ngrok 502（隧道找不到本地服务器）。
- `AI_WorkSpace/log_1657/current.log`（提取自 2025-11-07T16-57-07Z.zip）显示同样的 `ClientConnectorError`，且 `RuntimeSupervisor` 的 healthcheck 因 `xpending` 参数变动曾抛出 TypeError，虽然代码已修复，但说明这段时间服务多次重启却始终没能成功注册 webhook。

## Technology Stack Notes
- ngrok 官方文档指出，如果本地 agent 未监听或者端口不可达，就会向访问者返回 502/504，这与当前“无进程监听 8010”完全一致（参见 /websites/ngrok 文档中关于 502 的一般描述）。

## Architecture Findings
- 入口层唯一依赖 Telegram Webhook；一旦 `_probe_telegram_webhook` 降级，整个消息链路停滞，没有回退通道。
- 由于我们把 `telegram_webhook` probe 标记为 non-hard，服务仍会继续运行但没有任何更新进入业务层，造成“看似在线、实际瘫痪”。
- `public_endpoint` 探针目前只写 capability，但没有将 HTTP 状态码写入日志，无法在日志里直观看到 502/400 场景，影响排障效率。
- 没有常驻进程管理（systemd / NSSM / pm2），测试完毕后服务被手动终止，导致 ngrok 隧道只剩下 502 页面。

## Next Actions Trace
- 需要向用户报告：1) 本地 uvicorn 未运行导致 502；2) 即使运行也因外部网络访问 Telegram 失败而无法获取更新；3) 建议对 public endpoint 和 webhook probe 实施更严格的阻断策略，并安排长驻进程。
