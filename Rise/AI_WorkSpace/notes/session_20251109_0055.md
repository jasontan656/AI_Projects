# Session Notes 2025-11-09 00:55 CST

## User Intent
- 临时授权扫描 `D:\AI_Projects\Up` 前端仓库，确认现有最小 MVP（Prompts + Nodes 工作台）是否足以与 Rise 后端连通，支撑 Telegram Bot 打通测试。

## Repo Context
- 视图：`src/views/PipelineWorkspace.vue:1` 定义 Nodes/Prompts Tabs、阶段化菜单与布局，`nodesStage/promptStage` 控制菜单→创建→管理流程，头部 CTA 仅对 Prompts 展示返回/新建按钮。
- 组件：
  - `src/components/PromptEditor.vue:1` 全屏/分栏提示词编辑器，提供 `newEntry/syncBaseline/isDirty/refresh` 等方法；`PromptCodeEditor` 负责 Markdown/YAML/JSON 语法高亮。
  - `src/components/PromptSubMenu.vue:1`、`src/components/NodeSubMenu.vue`（未查看但 pipeline 复用）负责菜单卡片 CTA。
  - `src/components/PromptList.vue:1`、`src/components/NodeList.vue:1` 双列管理列表；`src/components/NodeDraftForm.vue:1` + `src/components/NodeActionList.vue:1` 支持节点动作（prompt append -> system prompt）。
- 状态层：
  - `src/stores/promptDraft.js:1` 维护 prompts 列表/选中项、`refreshPrompts()`；
  - `src/stores/pipelineDraft.js:1` 维护节点草稿及动作集合。
- 服务：
  - `src/services/httpClient.js:1` 统一 `requestJson`，默认 `VITE_API_BASE_URL=http://localhost:8000`（`.env.development`）并附加 `X-Actor-*` 头；
  - `src/services/promptService.js:1` 对接 `/api/prompts` CRUD；
  - `src/services/pipelineService.js:1` 对接 `/api/pipeline-nodes`，创建/更新时将动作序列化为系统 Prompt。
- 契约：`docs/contracts/prompt-draft.json:1`、`docs/contracts/pipeline-node-draft.json:1` 描述前端输出结构，指导后端持久化策略。
- 开发记录：`AI_WorkSpace/notes/session_20251107_0615.md` + `DevDoc/On/session_20251107_0615_prompts_layout.md` 详述 prompts 阶段化改造、未保存守卫与 GIVEN/WHEN/THEN 验收。

## Technology Stack
- Vue 3.5 + Vite 5 + Pinia 2（`package.json`），Element Plus 2.9 提供 UI，Codemirror 6 处理代码编辑。
- HTTP 通过原生 fetch + JSON；无 GraphQL/WebSocket 依赖。
- 构建脚本：`npm run dev/build/test`。

## Search Results
1. **Element Plus Layout 指南**（Context7 `/element-plus/element-plus`，layout.md & card.md）：需 import layout/display 样式以保持 responsive 栅格一致；`el-card` 支持 header/body/slots，适合 prompts/menu 卡片的 CTA 结构。强调 dark-mode/custom CSS 变量可用于保持 nodes/prompts 视觉统一。

## Architecture Findings
- **Prompts/Nodes 编辑链路完整**：`PipelineWorkspace.vue:1-320` 已具备三阶段交互、未保存守卫 (`ensureCanLeavePromptStage`) 与列表刷新逻辑，配合 `PromptEditor` 的 baseline/dirty 方法，可支持最小闭环（创建模板→节点引用→保存）。
- **API 面向 Rise**：`httpClient.js:1-52` 默认指向 `localhost:8000` 并附 actor headers，`promptService.js`、`pipelineService.js` 的输入校验与 ID 编码与 Rise 新后端契约对应，可直接调用后端 `/api/prompts`、`/api/pipeline-nodes` 以生成 workflow 所需资源。
- **节点动作与提示词关联**：`NodeActionList.vue:1-200` 支持将 prompt templates 绑定至动作并预览 Markdown；`nodeActions.js:1-120` 会序列化为 `{{template:ID}}`，满足后端关于系统 Prompt 的期望（`composeSystemPromptFromActions`）。
- **契约输出完备**：docs/contracts/*.json 明确 `id/name/markdown/createdAt` 与 `actions` 结构，方便与 Rise 后端 Schema 对齐，减少 E2E 时的字段歧义。
- **缺口 1 – Telegram 配置入口缺失**：前端尚无渠道/工作流绑定 UI，也没有 workflow 列表或按钮去触发“将Telegram绑定某条 workflow”。目前仅能创建节点+提示词，无法在 UI 中设置 Telegram workflowId 或 policy，需通过后端/数据库操作弥补。
- **缺口 2 – Prompt 最终输出尚未暴露 workflowId**：`PromptEditor`/store 只维护模板内容，并未提供“发布”或“分配 workflow”操作；Rise 侧需要 Workflow Builder 视图或 CLI 将 prompts/nodes 组合成 workflow，前端暂不提供该视图。
- **缺口 3 – 错误可观测性有限**：`requestJson` 捕获 HTTP 错误但只抛出 Error；PipelineWorkspace 中仅在 refreshPrompts 失败时 toast，其余 API（create/update/delete）未统一 toast 反馈，需要依赖 console/Element MessageBox，可能在最小联调中漏掉异常。
- **风险 – 本地 env 与托管环境不一致**：`.env.development` 默认 actorId=dev-actor，若 Telegram 测试依赖生产身份，需要在前端发布环境配置新的 `VITE_API_BASE_URL` 和 actor headers，否则将请求本地服务导致 404。

## Defensive Considerations
- 在最小联通测试前需确认：1) `.env` 指向 Rise 后端，并在浏览器 localStorage 设置与后端匹配的 Actor/Tenant；2) prompts/nodes API 路径 `/api/prompts`, `/api/pipeline-nodes` 已由后端实现，否则前端所有保存操作会失败。
- 若需要将 prompts 立即给 Telegram 使用，需后端提供 Workflow Builder 或脚本将 nodes/prompt 模版生成 workflowId；前端目前无入口。
- Telegram Bot 联调过程中，若 prompts 编辑器存在未保存更改，`ensureCanLeavePromptStage` 会阻断导航，需要提示测试人员先保存；否则 prompts 列表不会刷新，易误判为前端缺陷。
- Node 动作仅实现 prompt append；工具/输出动作按钮禁用（`NodeActionList` 中第二个 CTA disabled），意味着 Telegram 流程暂时只能基于模板提示，不支持工具调用；需在测试计划中限制期望。

## File References
- `src/views/PipelineWorkspace.vue:1` – Workspace 模板与阶段逻辑。
- `src/views/PipelineWorkspace.vue:232` – `nodesStage/promptStage` 状态及守卫实现。
- `src/components/PromptEditor.vue:1` – 提示词表单、保存按钮与暴露的 helper 方法。
- `src/components/PromptList.vue:1` – 列表与删除流程。
- `src/components/PromptSubMenu.vue:1` – Prompts 菜单 CTA。
- `src/components/NodeDraftForm.vue:1` – 节点创建表单与动作列表引用。
- `src/components/NodeActionList.vue:1` – 节点动作卡片与 prompt 模板绑定。
- `src/stores/promptDraft.js:1`、`src/stores/pipelineDraft.js:1` – Pinia 状态管理。
- `src/services/httpClient.js:1`、`src/services/promptService.js:1`、`src/services/pipelineService.js:1` – API 客户端。
- `docs/contracts/prompt-draft.json:1`、`docs/contracts/pipeline-node-draft.json:1` – 契约定义。
- `AI_WorkSpace/DevDoc/On/session_20251107_0615_prompts_layout.md` – Prompts 阶段改造设计。
