# Session Notes 2025-11-07 09:55 CST

## User Intent
- 針對最新一輪啟動測試，使用者指出四個問題：\
  (1) 能力探針只在啟動時執行一次，若判定依賴不可用，整個 runtime 便停留在關閉狀態。\
  (2) 即便套用新的日誌策略，仍持續輸出 `knowledge.redis_unavailable`、`task_runtime.disabled` 以及 `py.warnings`（特別是 `RuntimeWarning: coroutine 'RobustConnection.close' was never awaited` / `Unclosed client session`）。\
  (3) Docker 映像尚未更新以符合本地後端設定，導致容器內的 Mongo/Redis/RabbitMQ 永遠連不到。\
  (4) 期望 console 為固定面板：啟動時顯示 “starting…”，成功後變成 “ok”，若有 warning/error 則在面板底部追加去噪後的訊息，讓 console 更整潔。
- 最新補充：現行 `ConsoleDashboardHandler` 仍然出現兩個面板（狀態 +  feed）並在狀態刷新時閃爍，推測是 `Table.grid`/`Layout` 重建導致；需求是「單一預置面板」內部顯示所有 slot，錯誤 Panel 以單列形式在同一面板的下方排布。另有新的錯誤日誌（具體內容待查，可能與 Rich handler 重複創建或 fallback renderable 轉換有關），需要一併解決。
- 最新補充（2025-11-07 11:40）：「噪音」已解決，但視覺仍尷尬：同一面板似乎被重複渲染/堆疊（可能 Live 被多次 `update` 且 Panel 重新实例化）；用户怀疑当前实现未真正定义模板，而是根据事件重建 UI。新诉求：将控制台视为“半个显示界面”，先设计模板（slot、警告区、扩展空间等），再将状态/错误作为 payload 投入模板，从而锁死布局、避免重复结构；可探索 CLI app 的仪表盘模式。

## Repo Context
- `src/interface_entry/bootstrap/app.py:339-738`：定義 Mongo/Redis/RabbitMQ/Telegram 的 `CapabilityProbe`，並在 `lifespan` 中只依 `runtime_enabled = _capabilities.is_available(...)` 決定是否啟動 `TaskRuntime`，造成探針結果無法在 runtime 期間復原。`lifespan` 的 `async with application_lifespan()` 也會在 `CancelledError` 冒泡時提前結束，未來得及關閉 `bootstrap_state.bot.session`。 
- `src/interface_entry/runtime/capabilities.py:12-114`：`CapabilityRegistry` 僅提供 `set_state/get_state` 與 `run_probe`，缺乏事件通知/觀察者，因此 TaskRuntime、Knowledge snapshot 等無從得知能力變化。
- `src/business_service/knowledge/snapshot_service.py:264-314`：`_sync_to_redis()` 每次備援同步都嘗試 `redis.Redis.from_url(...).ping()`，失敗就 `logger.warning("knowledge.redis_unavailable", ...)`，沒有冷卻或 capability 條件判斷。
- `src/interface_entry/http/dependencies.py:171-223`：`get_task_runtime()` 在啟動時計算 `runtime_enabled` 一次，若 redis/rabbitmq 初始不可用就永久回傳 `DisabledTaskRuntime`，與使用者 observation 一致。
- `var/logs/current.log` / `var/logs/rise-info.log`：顯示 09:38-09:49 間反覆記錄 `startup.capability` 與 `knowledge.redis_unavailable`，以及 `py.warnings` 來自 `pymongo/periodic_executor.py:174` 提示 `Unclosed client session`。
- `project_utility/logging.py:150-233`：目前 console handler 依事件即時輸出，尚未提供「固定面板 + 追加錯誤」的 Live 體驗。
- Docker/Compose：repo 中尚未有 `docker-compose.yml`，`.env` 預設仍指向 `localhost`，與文檔 `session_20251107_0825_telegram_resilience.md` 要求的 `mongo/redis/rabbitmq` service name 不符。

## Technology Stack
- FastAPI + Starlette Lifespan、Uvicorn ASGI server。
- Motor / PyMongo、redis-py、aio-pika（RabbitMQ）、Aiogram（Telegram bot）、aiohttp（HTTP client）。`aiohttp` 的 session 若未顯式關閉會在 `__del__` 時發出 `ResourceWarning`。
- Rich Console/Panel/Live Handler 自訂輸出；Log rotation 透過 `project_utility.logging`.
- Docker Compose（尚需建立）將提供 MongoDB 7.x、Redis 7.2、RabbitMQ 3.13 管理面板。

## Search Results
- **FastAPI Lifespan**（context7 `/fastapi/fastapi`, topic “lifespan shutdown graceful”）強調使用 `@asynccontextmanager` 的 lifespan 中 `yield` 前後各處理初始化/釋放資源；測試時以 `TestClient` 驗證啟停流程。支持我們在 `lifespan` 中捕捉 `CancelledError`、確保 Telegram session/RabbitMQ 連線被正常清理。
- **Rich Panel 與 Console API**（exa `https://rich.readthedocs.io/en/stable/panel.html`, `https://rich.readthedocs.io/en/latest/console.html`）提供 Panel 與 Console 的 layout、`Panel.fit`, `Panel(expand=False)` 以及 `Console().print()` 使用示例，適合作為 “固定面板 + 事件流” 的基礎。
- **aiohttp ClientSession Warning**（web search `turn0search0` ~ `turn0search3`）文件說明 `ClientSession.__del__` 會在 session 未關閉時發出 `Unclosed client session` 警告，並建議在關閉事件迴圈前 `await session.close()` 或至少 `await asyncio.sleep(0)` 讓底層連線釋放；`turn0search1` 的 “Graceful Shutdown” 小節特別指出 SSL 連線需延遲一小段時間以避免該 warning。
- **Rich 固定布局**（context7 `/textualize/rich`, topic “Live layout with panels static sections”）說明可透過 `Layout.split/ split_row` 預先定義區塊，再用 `Layout[name].update()` 變更內容，確保面板位置固定。`Table.grid` 亦可用於建立「不可見」布局來垂直堆疊多個 Panel。
- **Rich Live Dashboard 案例**（exa `dev.to/nish2005karsh/...cli-dashboard`）示範 `Live` + `Layout` 的方式：先預建 header/body/footer，再於迴圈內更新 layout slot。這種方式與使用者所述「預置內容，僅更新狀態」一致，可避免錯誤面板與主面板併排。

## Architecture Findings
- Capability 機制沒有「事件通知 + runtime 自動恢復」，因此 Redis/RabbitMQ 初次不可用時，TaskRuntime、Knowledge snapshot 會永久停留在降級狀態，即便背景 probe 已把 capability 設為 `available`。
- `knowledge.redis_unavailable` / `task_runtime.disabled` 的 warning 直接由業務邏輯輸出，沒有節流或能力條件檢查，導致長時間噪音；亦會在排程內反覆觸發 Redis 連線嘗試。
- `py.warnings` 來自 Telegram bot 內的 `aiohttp.ClientSession` 在 `CancelledError` 流程中未被關閉；同時 `project_utility.logging` 在 interpreter 關閉時仍嘗試渲染 Panel，造成 `ImportError: sys.meta_path is None`。
- Docker 部署仍未同步 `.env` 與本地 compose 服務名稱，導致 `MONGODB_URI` 等繼續指向 `localhost`，與實際容器網路不一致。
- Console 還是逐行輸出，無法滿足 “面板 + 狀態燈” 的需求；也缺乏 warning/error 去噪與聚合策略。
- 当前版本虽改用单 Panel 包裹，但仍在 `_render_view()` 中临时构造 `Group(status, Text(...), feed)` 并将 `feed` 渲染成 Panel 列表，导致 Live 每次刷新都在终端写入新的 Panel 边框，用户体感为“重复/闪烁”。缺少“模板即界面”的思路：应该先定义 Panel 模板，再把状态/告警作为 data payload 注入，而非重建 renderable。
- `_extra_capabilities`、`_alerts` 仍是普通 OrderedDict，但模板概念缺位：slot 须在模板层确定（是否允许扩展、如何填空等）；没有模板语义就难以“锁死”排版，也限制后续 CLI 半 GUI 化的扩展。

## File References
- `src/interface_entry/bootstrap/app.py:339-738`（Probe + Lifespan）。
- `src/interface_entry/http/dependencies.py:171-223`.
- `src/business_service/knowledge/snapshot_service.py:264-314`.
- `project_utility/logging.py:150-233`.
- `var/logs/current.log`、`var/logs/rise-info.log`（09:38-09:49 日誌）。

## DevDoc 更新
- 2025-11-07 09:55 在 `AI_WorkSpace/DevDoc/On/session_20251107_0955_system_resilience.md` 完成《系统运行自愈与观测升级方案》，覆蓋 capability 自愈、warning 去噪、Docker Compose、新 console 面板四大議題，並補全成功路徑 / 防禦模式 / GIVEN-WHEN-THEN 驗收條目，可作為後續開發藍本。***

- 2025-11-07 12:05：用户认为引入 Textual 成本过高，要求放弃迁移方案，继续在既有 Rich logging handler 内解决模板/闪烁问题。

## 2025-11-07 12:30 运行修复记录
- 用户要求直接在本地复现 `python -m uvicorn interface_entry.bootstrap.app:app --app-dir src --host 0.0.0.0 --port 8000` 的失败并修到可跑，长命令需 15 秒 timeout。
- 缺失依赖 `aio-pika==9.4.2`（requirements 已列出）导致 `ModuleNotFoundError`；使用 `D:/Python310/python.exe -m pip install aio-pika==9.4.2` 补齐，连带安装 `aiormq==6.8.1`、`pamqp==3.3.0`。
- `project_utility/logging.py` 中被删去的结构需要恢复：
  - 新增 `_MaxLevelFilter` 以限制 info log handler 的最高等级。
  - 新增 `SyncLogHandler` 将 INFO 行同步写入 `current.log`，满足 workspace tailing。
  - 补回 `_runtime_shutting_down()` 检查、`_collect_record_extras()`、`_resolve_warning_summary()`，并确保 console handler 依赖都存在。
- 以 15 秒 timeout 重跑 uvicorn：`logging` NameError 均已解决，服务完成启动（Aiogram Router、行为路由、能力探针均完成），但因 `host.docker.internal:5672` 上的 RabbitMQ 不可达，`aio_pika.robust_connection` 按 5 秒间隔重试并产生 `TimeoutError`，属外部依赖缺失导致的降级日志。
- 命令因 timeout 机制被动中断；若需保持运行，可将 timeout 提升或改用手动 Ctrl+C。当前状态下应用已完成 FastAPI 启动并接受请求，但消息队列依赖仍需拉起或切换至降级模式。

## 2025-11-07 13:10 Docker 契约落地
- `docker-compose.yml` 更新：所有資料層服務統一掛載 `rise-stack` 網路，Mongo 綁定 `docker/mongo/init` 以注入 `001-init-replica.js`，健康檢查改用帶認證的 `mongosh` `db.adminCommand({ ping: 1 })`，RabbitMQ 使用 `rabbitmq-diagnostics check_port_listener --port 5672`，Redis 以 `redis-cli PING` 驗證；volume 仍落在 `./var/docker/<service>` 方便持久化。
- 新增 `docker/mongo/init/001-init-replica.js`，於容器首次啟動時自動執行 `replSetInitiate` 並輪詢 `replSetGetStatus`，若 replica set 已存在則輸出摘要並返回成功，避免多次初始化。
- `.env` 中的 `MONGODB_URI` 改為 `mongodb://root:changeme@mongo:27017/?replicaSet=rs0&authSource=admin`，與 compose root 認證保持一致，`*_HOST_OVERRIDE` 依舊提供宿主切換能力。
- `tools/docker_db_check.py` 擴充 CLI 參數（`--mongo-username/--mongo-password/--mongo-auth-db/--rabbit-port`），Mongo 檢查腳本改讀 `rs.status()` 並輸出 JSON 摘要，RabbitMQ 檢查轉向 `check_port_listener` 確認 5672 端口可用，維持結構化報告供 CI 使用。
- 2025-11-07 13:25：Compose 以 root 執行 `docker/mongo/entrypoint.sh` 先把 `docker/mongo/keyfile/keyfile` 複製到 `/tmp/mongo-repl.key` 並設定 600 權限（宿主 Windows 無法直接 chmod），然後再調用官方 entrypoint；對外端口因 27017/5672/15672 被 Docker Desktop 佔用暫不映射，只允許容器網路互通。
- `001-init-replica.js` 在 init 階段檢測到 “not running with --replSet” 會直接退出，使 initial bootstrap 不再重啟；真正的 replica set 初始化由 `tools/docker_db_check.py` 負責：偵測 `NotYetInitialized` 或 `no replset config has been received` 後，會自動執行 `rs.initiate({_id:'rs0', members:[{_id:0, host:'mongo:27017'}]})` 再重跑健康檢查。
- 驗證命令：`docker compose up -d mongo redis rabbitmq`（3 個 service 均為 `STATUS=Up ... (healthy)`）＋ `D:/Python310/python.exe tools/docker_db_check.py --compose-cmd "docker compose"`，目前輸出 OK，Mongo 檢查結果 `{"set":"rs0","members":1,"primary":"mongo:27017"}`。
- 2025-11-07 13:35：為解決宿主 FASTAPI 無法連線 container（無對外映射）導致的 `redis_unavailable` 日誌，重新開啟但換高位埠：Mongo `37017->27017`、Redis `6380->6379`、RabbitMQ `56730->5672`/`15680->15672`，同時將 `.env` 內的 `MONGODB_URI`/`REDIS_URL`/`RABBITMQ_URL` 改為 `localhost` + 新埠並清空 `*_HOST_OVERRIDE`，確保主程式直接命中宿主端口。`tools/docker_db_check.py` 在新的映射下仍全綠。
- 2025-11-07 17:40：補上 `.env` `DOCKER_HOST_BRIDGE=""`，避免 `_apply_host_override_env()` 把連線又改回 `host.docker.internal`。同時調整 `CapabilityRegistry.run_probe()` 僅在首次寫入狀態時才輸出 `startup.capability`，把後續監測頻率造成的刷屏問題壓制住；現在實際啟動時只會看到每個 capability 初始化一次的訊息，觀察 30 秒無再度刷屏，`redis_enabled=True` 且不再產生 `knowledge.redis_unavailable`。
