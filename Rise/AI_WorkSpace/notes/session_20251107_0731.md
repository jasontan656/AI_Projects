# Session Notes 2025-11-07 07:31 CST

## User Intent
- 根據使用者指示，在中國時間 2025-11-07 07:31 讀取 `var/logs` 最新日誌，分析當前錯誤情況並提出根因與修復建議。

## Repo Context
- `var/logs/rise-error.log` (更新於 2025-11-07 07:27) 多次記錄 `pymongo.errors.ServerSelectionTimeoutError`，顯示 FastAPI 介面（如 `pipeline_nodes` 與 `prompts` 路由）在建立索引時無法連上 `localhost:27017`。
- `src/interface_entry/http/dependencies.py:40` 定義 `AppSettings` 從 `.env` 讀取 `MONGODB_URI`/`MONGODB_DATABASE`，並在 `get_mongo_client` 中建立全域 `AsyncIOMotorClient`。
- `src/interface_entry/http/dependencies.py:108` 每次解析依賴時都會新建 `AsyncMongoPromptRepository`、`AsyncMongoPipelineNodeRepository` 等，導致 `_ensure_indexes` 在每個請求週期裡至少跑一次。
- `src/business_service/prompt/repository.py:186` 與 `:207` 內的 `AsyncMongoPromptRepository` 在所有 CRUD 操作前呼叫 `_ensure_indexes`，若 Mongo 未啟動就立即丟出連線錯誤。
- `src/business_service/pipeline/repository.py:203`、`:272` 類似會在 `list_nodes` 等方法前建立索引；與 prompt repo 同樣依賴 `localhost:27017`。
- `.env:41-42` 將 `MONGODB_URI` 設為 `mongodb://localhost:27017` 並指定資料庫 `rise`，與日誌中的連線目標一致。
- `src/interface_entry/http/dependencies.py:171` 在應用生命週期啟動時同步初始化 `WorkflowTaskProcessor`，同樣使用 `get_sync_mongo_database`，因此 Mongo 若未啟動整個生命週期也會失敗。

## Technology Stack
- FastAPI 0.111 + Starlette + Uvicorn 為 HTTP 介面層。
- Motor 3.5.1 + PyMongo 4.6.3 作為 Mongo 異步/同步客戶端；Redis 5.0.4、aio-pika 9.4.2 用於佇列/任務執行。
- 其他依賴：Aiogram (Telegram bot)、OpenAI SDK、pydantic v2、redis、rabbitmq、pdfminer、aio-pika（見 `requirements.lock`）。

## Search Results
- **context7 (/fastapi/fastapi, logging topic)**：提供 FastAPI 中如何在 middleware/exception handler 裡記錄請求內容與處理時間，可用來補強 Mongo 失敗時的診斷記錄。
- **exa (FastAPI background task failure)**：文章說明背景任務失敗常見原因（函式錯誤、排程錯誤、環境問題）與建議在任務內加入詳細記錄；對應我們需要在背景任務/啟動流程中檢查 Mongo 連線。
- **web (turn0search0)**：StackOverflow 解釋 `ServerSelectionTimeoutError` 多因 MongoDB 服務未啟動或連線參數錯誤，建議確認服務正在聆聽並檢查 `mongod --config` 或 Docker 容器狀態。
- **web (turn0search1)**：StackOverflow 討論 Docker Compose 中 `localhost` 指向錯誤網路命名空間，必須改用服務名稱或 `host.docker.internal`; 若 API 在容器中啟動，需要改寫 `MONGODB_URI`。
- **web (turn0search2)**：StackOverflow Windows 案例指出 `WinError 10061` 是本機埠未有服務在監聽，建議使用 `netstat -an | find "27017"` 驗證後啟動 Mongo。
- **web (turn0search3)**：MongoDB 官方論壇建議檢查 `mongod.conf` 綁定位址、firewall 與 replicaset 狀態避免 `connection refused`。
- **web (turn1search0)**：MongoDB 文件提供網路連線故障排除步驟（確認伺服器啟動、埠開放、客戶端 URI 指向正確伺服器/使用者）。

## Architecture Findings
- 當前 `.env` 假設本機 Mongo、Redis、RabbitMQ 都在啟動；在 production 佈署時若服務已容器化或部署到雲端，`localhost` 會指向容器本身導致無法連線。
- 依賴注入層每次請求都建立新的 repository 實例，因此 `_ensure_indexes` 雖有鎖但仍會觸發 Mongo 呼叫；當資料庫離線時每個 API 呼叫都會同步阻塞在索引建立而失敗。
- 應用啟動時 `application_lifespan` 會先跑 `get_task_runtime().start()`，勢必連線 Mongo 與 Redis；若 Mongo 未啟動，整體服務在接受到第一個 HTTP 請求前就進入錯誤狀態，缺乏健康檢查與降級路徑。
- 日誌顯示 pipeline/prompt 兩個模組都在建立索引時失敗，說明資料層連線問題是全域性的，而非個別資料集合。

## File References
- `var/logs/rise-error.log`：2025-11-07 07:27 CST 新增，包含 `ServerSelectionTimeoutError` 堆疊。
- `src/interface_entry/http/dependencies.py:40` (`AppSettings`)、`:108` (`get_prompt_repository`)、`:171` (`get_task_runtime`).
- `src/business_service/prompt/repository.py:186` (`list_prompts`)、`:207` (`_ensure_indexes`).
- `src/business_service/pipeline/repository.py:203` (`AsyncMongoPipelineNodeRepository.create` 等)、`:272` (`_ensure_indexes`).
- `.env:41-42` (`MONGODB_URI`, `MONGODB_DATABASE`).

## 2025-11-07 07:40 Update
- **User Intent**: 要求驗證 MongoDB/Redis/RabbitMQ 連線狀態並鎖定真正根因；關注 FastAPI 啟動時「HTTP connection」(Telegram Webhook) 造成 fast-fail，期望新增啟動自檢與降級邏輯，當特定後端不可用時，仍允許 API 啟動並對應路由回傳 Service Unavailable。
- **Runtime Checks**:
  - `tmp_mongo_check.py` (手動生成、使用 `.venv` Python 與 PyMongo) ping `mongodb://localhost:27017` 成功，輸出 `MONGO_OK {"ok": 1.0}`，排除 Mongo 實例離線。
  - `tmp_redis_check.py` 使用 `Redis.from_url(REDIS_URL)` -> `REDIS_OK True`。
  - `tmp_rabbit_check.py` 透過 `aio_pika.connect_robust(RABBITMQ_URL)` -> `RABBIT_OK amqp://guest:guest@localhost:5672/`。
- **Repo Context Additions**:
  - `src/interface_entry/bootstrap/app.py:200-520` 在 FastAPI lifespan 中串接 `bootstrap_aiogram_service`、`behavior_webhook_startup`；若 `_verify_telegram_connectivity` / `_handle_pending_updates` 失敗會 raise `TelegramWebhookUnavailableError`，導致 HTTP 伺服器無法啟動。
  - `lifespan` 先 `async with application_lifespan()` (啟動 Redis/Mongo runtime)，再做 Telegram 檢查 → 當 Telegram 網路失敗時整體服務終止，前端無法取得任何 HTTP 回應。
- **Architecture Findings**:
  - 缺乏「能力注入狀態」：`app.state` 沒有紀錄 Telegram/Mongo/Redis/Rabbit 的健康結果，因此無法在路由層有條件拒絕請求。
  - 啟動流程目前屬於全有或全無：任何一個依賴 (尤其 Telegram HTTP) 失敗會 raise，導致 API、健康檢查與非相關功能（例如 prompts 列表）全部不可用。
  - 需要在 `application_lifespan` 之外新增 startup probe，將結果寫入 `app.state.capabilities`，並在對應 router/dependency 中做 gate，返回 503 或明確錯誤碼；其餘功能可繼續運行。
- **Next Steps (for discussion)**:
  - 設計 `CapabilityRegistry`：紀錄 `mongo`, `redis`, `rabbitmq`, `telegram_webhook` 等狀態與最近一次檢測時間。
  - 在 FastAPI router 層（如 Telegram webhook、任務提交、prompt CRUD）新增依賴 `require_capability("mongo")` 等，若失敗回傳 `HTTP_503_SERVICE_UNAVAILABLE`。
  - 將 `_verify_telegram_connectivity`/`behavior_webhook_startup` 包在 try/except，失敗時僅標記 `telegram_webhook=degraded` 並跳過 raise，讓 `/healthz` 揭露 partial failure。
- **Doc Output**: `AI_WorkSpace/DevDoc/On/session_20251107_0731_startup_capability.md` 匯整了能力註冊表、啟動 probe、服務降級策略、健康檢查、成功路徑、失敗模式與 GIVEN/WHEN/THEN 驗收條件，可供後續開發/測試直接引用。
- **2025-11-07 实施**：完成能力注册表与启动自检实现——新增 `src/interface_entry/runtime/capabilities.py`，`create_app` 引入探针、后台监控、健康检查扩展，`interface_entry/http/dependencies.py` 注入 `set_capability_registry`、Mongo/Redis/RabbitMQ 硬性守卫，Telegram webhook 路由及内部任务控制器具备 503 降级逻辑。
- **2025-11-07 08:10 日志复查**：`var/logs/rise-error.log` 最新条目（07:27 CST）显示 `startup.telegram_backlog.unexpected_error` 与 `startup.telegram_backlog.unreachable`，紧随其后的 StackTrace 指向 `interface_entry/bootstrap/app.py` 在 `_handle_pending_updates` 多次重试 `bot.get_webhook_info` 失败后抛出 `TelegramWebhookUnavailableError`。同一批日志仍包含 `pymongo.errors.ServerSelectionTimeoutError`，说明 MongoDB 连接依旧被 `WinError 10061` 拒绝。
- **Search Update (2025-11-07)**：exa 检索“Telegram webhook unreachable fastapi startup handling service unavailable”（https://community.latenode.com/...）指出在 FastAPI 与 Telegram Bot 同进程时需要为 webhook/网络失败设计独立降级机制，避免 event loop 中的阻塞错误；该讨论进一步印证我们需要在 `_handle_pending_updates` 失败时向上层回传可观测状态而不是直接终止服务。
- **2025-11-07 08:20 追踪**：用户反馈所有基础服务已稳定运行，因此当前 `serverSelectionTimeoutError` 与 `startup.telegram_backlog.*` 更可能源自代码逻辑（如 capability 注册未在 lifepan 之前执行、依赖仍在初始化时访问 Mongo/Telegram），需重新审视 `create_app()` 中的探针执行顺序、`CapabilityRegistry` 何时写入 `mongo/telegram_webhook` 状态，以及 `get_prompt_service` 是否在 capability 未准备时就创建 `AsyncMongoPromptRepository`。
- **Doc Output**: `AI_WorkSpace/DevDoc/On/session_20251107_0825_telegram_resilience.md` 描述 telegram webhook 降级策略、docker 数据库地址改造、脚本巡检方案以及 GIVEN/WHEN/THEN 验收，用于指导后续实现与部署配置。
- **2025-11-07 08:45 实施**：按照 `session_20251107_0825_telegram_resilience.md` 完成代码落地：`bootstrap/app.py` 新增 `TELEGRAM_PROBE_MODE`/代理支持、探针细化（Mongo/Redis/RabbitMQ 记录 endpoint、Telegram 探测失败仅降级且不再阻断 lifespan），`/healthz` 仍基于 CapabilityRegistry；新增 `tools/telegram_probe.py` 与 `tools/docker_db_check.py`，并将 `.env` 的数据库 URI 指向 docker 服务名。
- **Doc Output**: `AI_WorkSpace/DevDoc/On/session_20251107_0905_log_lifecycle.md` 规定日志归档/清理策略：启动归档旧日志、生成同步 warning 日志，关闭时可选清理；包含成功路径、失败模式、GIVEN/WHEN/THEN。
