# Session Notes 2025-11-08 01:38 CST

## User Intent
- 用户担心 `RuntimeError: workflow_id_missing` 是否符合设计预期：当前前端尚未配置流程，Telegram 消息应该进入后端但被“兜底策略”留在 Redis+RabbitMQ，不应硬错误。希望我们确认并提出更优雅的行为。
- 期望我们在定位后端需要改动的点之后，准备一份新的文档记录本次修正；暂不要求直接更新旧文档。

## Repo Context
- `src/business_service/conversation/service.py:85-142`：`TelegramConversationService.process_update()` 先调用 `contracts_telegram_inbound()`，若未忽略则构建上下文；一旦 `_extract_workflow_id()` 返回空，直接 `raise RuntimeError("workflow_id_missing")`。该异常未被入口层捕获，会冒泡到 aiogram。
- `_extract_workflow_id()` 定义在同文件 167-204 行，只尝试从 `policy.workflow_id`、`policy.workflow.id` 或 update payload 中读取 `workflowId` / `workflow.id`。未配置前端流程时这些字段必为空，因而必然触发异常。
- `interface_entry/telegram/handlers.py:52-140` 的 `handle_message()` 仅捕获 `SchemaValidationError`，其他异常（含 `workflow_id_missing`）会导致 Telegram webhook 返回 500，Telegram 客户端重复发送同一 update。日志只看到 `aiogram.event` 的 RecursionError / RuntimeError，而业务层没有显式“忽略”记录。
- 当前任务投递链条（Redis Streams + RabbitMQ）只有在 `submitter.submit()` 成功后才会进入队列；`workflow_id_missing` 发生在投递前，所以并不存在“消息被缓存在 Redis+RabbitMQ”的事实，违背用户构想的兜底策略。

## Technology Stack / External Guidance
- FastAPI 官方文档（/fastapi/fastapi `handling-errors`）强调使用 `HTTPException` 或自定义异常处理器来返回 4xx，并保持 API 语义明确；任由未捕获异常冒泡会导致 500，对客户端产生误导。
- Better Stack 2025 指南指出：需要区分“操作性错误”（例如外部配置缺失）与“程序性错误”，前者应有可预期的用户反馈，而不是崩溃或无限重试。

## Search Results Summary
1. **FastAPI Error Handling（Context7 /fastapi/fastapi）**：展示如何使用 `HTTPException`、自定义异常 handler、以及返回 4xx 状态来提示客户端缺少资源或权限；支持我们把“未配置 workflow”视为业务级 4xx，并记录日志而非抛出 RuntimeError。
2. **Better Stack – FastAPI Error Handling Patterns（Exa https://betterstack.com/community/guides/scaling-python/error-handling-fastapi/）**：强调区分操作性错误，并通过集中式日志/定制响应避免不必要的 500。符合我们要将“流程缺失”作为可恢复状态、并提示“请先配置流程”的策略。

## Architecture Findings
- **设计冲突**：后端宣称“没有流程就不处理”，但实现为同步 RuntimeError，既没有写入 Redis/RabbitMQ，也没有给出引导信息，导致 Telegram 重试与日志噪音。需要改为“可观测的忽略/排队”机制。
- **兜底策略缺失**：目前没有任何路径在 workflow 缺失时把 update 放入 Redis/RabbitMQ；也没有 telemetry 指示“待处理流程缺失”。业务层与用户认知不一致。
- **入口层可用性**：`handle_message` 没有捕获业务异常，也没有在 metrics 中统计“因未配置流程而忽略”的次数；一旦 workflow 配置错误，会以 500 影响整条链路。

## Conclusions / Next Steps
- 需要在 `process_update()` 中，把缺少 workflow 视为业务级 ignored，返回 `ConversationServiceResult(status="ignored", error_hint="workflow_missing")`，并写日志提示“请先配置流程”；入口 handler 再根据 `status` 直接 200 回复 Telegram，使消息不会重复推送。
- 可选：把该状态存入 Redis/RabbitMQ 作为“待触发”任务，但若暂不实现，也要在日志/metrics 上明确记录“workflow_missing”事件，方便排障。
- 完成代码调整后，应依据用户要求，在 `AI_WorkSpace/DevDoc/On/session_YYYYMMDD_xxxx_workflow_missing.md` 新建文档，描述此行为及恢复流程。
