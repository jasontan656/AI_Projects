# Session Notes 2025-11-09 03:55 CST

## User Intent
- 阅读 `AI_WorkSpace/Reports/1.md`，核对后端实现，确认当前联调是否仅剩文档中提到的可观测性接口缺失这一处差距。

## Repo Context
- `AI_WorkSpace/Reports/1.md`: 记录后端排查结果，指出 CRUD（`POST /api/prompts`, `POST /api/pipeline-nodes`, `POST /api/workflows`）均可用，422 原因是缺少 systemPrompt/actions；当前 404 来自未实现的日志/变量/工具类接口。
- `src/interface_entry/http/workflows/routes.py:1-290`: FastAPI 路由仅覆盖 workflow 列表、创建、更新、发布（`/apply`）、任务查询等；未定义任何 `logs`, `variables`, `tools` 相关子路由，佐证 404 原因为未实现接口。
- `openspec/PROJECT_STRUCTURE.md`: 强制层级约束（Project Utility → Foundational Service → Business Service → Business Logic），Interface/Entry 层只能做协议转换；本次需要新增的日志/变量 API 必须落在 Interface + Business Service 的协同，而非直接写在 Foundational 层。
- `AI_WorkSpace/DevDoc/On/session_20251109_0355_workflow_observability.md`: WRITE 模式新增文档，输出日志/变量/工具 API 方案、分层落点、验收用例。

## Technology Stack
- 后端：FastAPI + Pydantic DTO，依赖 `AsyncWorkflowService`, `AsyncStageService`, `TaskRuntime`, `TaskSubmitter` 等业务/基础服务协同；ActorContext 注入请求人信息，用于审计与工作流更新。
- 任务执行：`/api/workflows/apply` 将请求封装为 `TaskEnvelope`，写入 Persist Worker 队列，`/api/workflows/tasks/{task_id}` 供轮询查询。

## Search Results
1. Context7 `/element-plus/element-plus` layout docs：提醒需要导入 `display.css` 以启用响应式隐藏类，支撑前端菜单/日志面板在小屏下行为一致。
2. Context7 `/fastapi/fastapi` StreamingResponse 指南：提供 SSE/StreamingResponse 的标准实现方式，可直接用于 `GET /api/workflows/{id}/logs/stream` 的增量输出，需指定 `media_type='text/event-stream'` 并使用 async generator。
3. Exa `pipeline prompt system guide`：示例仓库将 prompts/nodes/workflows 分层存储，强调 workflow 目录内还需日志/可观测性资产，可作为后端补齐日志 API 时的参考目录结构。
4. Exa `Vellum Long Running Workflows`：提出 workflow 执行应通过 streaming endpoint 返回 `execution_id` 并配合 webhook 提供状态同步，强调需要同时提供历史查询和实时事件回传机制。
5. Web DeepWiki `firecrawl/open-agent-builder` SSE streaming endpoint：`POST /api/workflows/[workflowId]/execute-stream` 以 SSE 提供实时执行事件，印证我们需要的 `logs/stream` 接口在其他系统中的常见设计；另补充 Galileo `Log Workflows` API（exa 结果）展示可观测性端点通常包括 `logs`, `variables`, `tools`, `metrics` 等细分资源。

## Architecture Findings
- Rise 后端当前仅暴露 workflow CRUD + apply/任务查询，未暴露任何 workflow 级别的日志、变量、工具查询或 SSE streaming，这与 `Reports/1.md` 描述完全一致。
- 由于 `routes.py` 不存在对应路由，前端文档中新增的 `logService`、`workflowMetaService` 请求必然 404，问题不在 URL 拼写而是后端暂未实现。
- workflow 应用链路依赖队列+TaskRuntime，没有可直接复用的历史日志检索接口；若要补齐，需要新增 TaskRuntime 或 Persist 层查询以支撑 `logs?limit=` 与 SSE streaming；需遵守 `PROJECT_STRUCTURE` 的分层要求：Interface 层只声明路由，业务编排放在 Business Service 中，日志存储/查询可落在 Foundational 服务或 Project Utility 数据访问。

## Defensive Considerations
- 在补齐日志/变量 API 前，前端需屏蔽或降级相关入口，避免反复触发 404 影响用户体验与监控。
- 若新增 SSE `logs/stream`，必须考虑 TaskRuntime 的 back-pressure 与连接超时；报告建议的 `waitTimeoutSeconds` 逻辑可复用。
- 历史日志导出要考虑 ACL（ActorContext）与多租户隔离，防止不同租户读取他人 workflow 运行数据。

## File References
- `AI_WorkSpace/Reports/1.md`
- `src/interface_entry/http/workflows/routes.py`
