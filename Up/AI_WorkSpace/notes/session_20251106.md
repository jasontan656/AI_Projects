# 会话笔记 2025-11-06

## 用户意图
- 用户希望左侧导航中的 `Nodes` 菜单项在点击后于右侧主区域弹出节点子菜单，让其选择“新建节点”或“查看已建节点”，当前实现与预期不符，要求讨论修正方案。

## 仓库上下文
- `src/views/PipelineWorkspace.vue:138-360`：`Nodes` 主体视图的组合式逻辑，`nodesViewMode` 默认值为 `manage`，`nodesMenuVisible` 控制一个定位在侧边栏外的浮动 `<NodeSubMenu>`；`handleMenuClick` 仅在侧边栏附近切换浮层显示，未驱动主区域切换到菜单态。
- `src/components/NodeSubMenu.vue:1-52`：当前子菜单为居中对齐的卡片组件，仅提供两个按钮事件 `create` 与 `manage`，无容器态或入口态样式设置。
- `src/components/NodeList.vue:1-160`：节点管理视图左列，始终渲染在 `nodesViewMode === 'manage'` 时；使用 Pinia `pipelineDraftStore` 读取节点数据与选中状态。
- `src/stores/pipelineDraft.js:1-86`：节点草稿状态管理，暴露 `setSelectedNode`、`resetSelection` 等操作，当前流程在菜单切换时没有对其进行阶段性复位。

## 技术栈
- 前端框架：Vue 3.5.22（组合式 API）。
- UI 组件：Element Plus 2.9.3（`el-menu`、`el-card`、`el-button` 等）。
- 状态管理：Pinia 2.3.1；路由：Vue Router 4.6.3；构建：Vite 5.4.21。
- 其他依赖：@vue-flow/core、@vueuse/core、Codemirror 相关模块、uuid 等。

## 搜索结果
- Context7 `/element-plus/element-plus`：“Menu component” 文档节提供菜单事件类型（`MenuSelectEvent`、`MenuOpenEvent` 等）与 click-outside 的实践示例，可用于评估以 Vue 指令管理子菜单弹层的替代方案。
- Exa `https://element-plus.org/en-US/component/menu`：介绍 `el-menu` 与 `el-sub-menu` 组合，强调垂直菜单可嵌套子菜单并支持 `menu-trigger`、`popper-offset` 等配置，为确定子菜单以主区域渲染或以 Popper 浮层展示提供参考。
- Web 搜索 `Menu 菜单 | Element Plus`（2025-07-02 抓取）：中文文档说明垂直菜单和子菜单行为，补充 `default-openeds`、`collapse` 等属性；另有 51CTO 等站点给出 Element Plus 左侧导航实践文章，可用以比对常规后台布局的右侧内容切换模式。

## 架构发现
- 子菜单定位在 `.workspace-aside` 外部，通过绝对定位形成浮层，未在主内容区域呈现，违背用户期望的“右侧弹出”流程。
- `nodesViewMode` 缺少 `'menu'` 阶段，导致主区域默认直接展示管理/创建面板；点击侧栏 `Nodes` 仅切换浮层可见性，无法让主内容回到菜单选择态。
- 返回按钮 `enterNodesMenu` 仍调用 `showNodesMenu()`，继续复用浮层形式，未提供主区域阶段化入口。
- 事件监听 `document.addEventListener('click', handleDocumentClick)` 在菜单态与内容态之间缺少同步逻辑，若未来改为主区域渲染需重构以避免空引用。
- 输入焦点与可达性未覆盖：当前浮层未处理键盘导航、ESC 关闭、窗口尺寸变化时的可视化位置回调，与 Element Plus 既有的 `el-popover`/`el-drawer` 模式不一致。

## 防御性设计与边界情况
- 需考虑空节点数据时的默认阶段：当 `pipelineStore.nodes` 为空，应引导用户直接进入“新建节点”，并保持菜单流程的幂等性。
- 多 Tab 场景：重复点击 `Nodes`、切换到其他导航再返回，需要重置 `nodesMenuVisible` 并同步 `nodesViewMode`，避免主区显示旧数据而菜单浮层缺失。
- 交互中断：创建节点过程中如果用户重新打开菜单，“新建”操作应确认是否丢弃未保存草稿；可通过 store 追踪脏状态并提示。
- 小屏幕/折叠侧边栏：现有绝对定位在响应式布局下可能出现遮挡，改为主区域渲染时需保证在移动端栅格中可滚动、可关闭。
- 后续扩展：若需要新增更多节点操作（复制、导入、批量删除），当前静态双按钮布局难以扩展，应规划操作描述模型（label、icon、action）以便动态渲染。

## 文档输出
- `AI_WorkSpace/DevDoc/On/node-menu-stage-refactor.md`：整理节点菜单阶段化方案，涵盖阶段状态机、组件改造、成功路径、失败模式与 GIVEN/WHEN/THEN 验收检查。
