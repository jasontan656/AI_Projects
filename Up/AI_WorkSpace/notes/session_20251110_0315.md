# 会话记录（session_20251110_0315）

## User Intent
- 用户质疑当前 Workspace 中 workflow 与 node/prompt 的关系，认为 workflow 先出现但节点和提示词为空导致逻辑错误，需要澄清系统设计及依赖顺序。

## Repo Context
- `src/views/PipelineWorkspace.vue:1-165`：主菜单分成 Nodes / Prompts / Workflow。Nodes、Prompts 采用“菜单→创建→管理”三段式，而 Workflow 独立引用 `<WorkflowBuilder />`，说明 workflow 是前两类资产的编排层。
- `src/components/WorkflowEditor.vue:32-95`：Workflow 编辑器的“节点执行顺序”和“提示词绑定”直接使用 props `nodes`、`prompts`；`nodePromptMap` 以 nodeId 为键绑定 promptId，验证 workflow 只是引用库中的节点/提示词。
- `src/views/WorkflowBuilder.vue:5-84`：编辑器 Tab 把 `pipelineStore.nodes` 与 `promptStore.prompts` 传入 `WorkflowEditor`，其他 Tab (Channel/Logs/Catalog) 仅在 workflow 发布后启用。
- `src/views/WorkflowBuilder.vue:534-556`：`watch` 钩子在 workflow 或 Tab 变化时调用 `fetchNodes()/fetchPrompts()` 与 `loadChannelIfNeeded()`，空数据场景会停留在空态，未自动生成节点或提示词。
- `src/stores/pipelineDraft.js:1-74`：Pinia store 维护节点草稿，`replaceNodes` / `addNodeDraft` 需要后端 `/api/pipeline-nodes` 返回的真实节点，workflow 不会代为生成。
- `src/stores/promptDraft.js:1-66`：提示词 store 同理，`refreshPrompts` 通过 `/api/prompts` 拉数据。
- `src/stores/workflowDraft.js:1-143`：`currentWorkflow` 结构含 `nodeSequence`、`promptBindings`，保存/发布需要这两个字段完整。
- `src/services/workflowService.js:3-80`：`sanitizeWorkflowPayload` 仅接受 nodeIds 与 `{ nodeId, promptId }` 列表，证明 workflow API 只是引用外部资产。

## Technology Stack
- Vue 3 + Composition API，Element Plus，Pinia，Vite。
- 后端接口：`/api/pipeline-nodes`、`/api/prompts`、`/api/workflows` 等 FastAPI 路由，通过 `requestJson` 统一封装。

## Search Results
- Context7 `/element-plus/element-plus`（card layout）：强调卡片与布局复用，支持 Nodes/Prompts 菜单式交互一致性。
- Exa（“workflow node prompt architecture multi-stage pipeline”）：Prompts.ai、Azure Prompt Flow 等案例均把 workflow 视为节点组合层，节点/提示词先存在。
- Web 搜索（turn0search0–turn0search10）：Dataloop、Circuitry、ChainOpera、n8n、AWS Bedrock 等近年方案也遵循“资产库→workflow 编排”路径，印证当前拆分合理。

## Architecture Findings
- 逻辑次序：必须先在 Nodes & Prompts 中沉淀可复用资产，再到 Workflow 进行编排；workflow 不负责生成节点或提示词。
- 当前 UX 未显式提醒“若节点/提示词为空则 Workflow 也无法配置”，需要额外提示或跳转 CTA。
- `syncPromptBindings` 只在节点选择变化时触发，若节点被后台删除，workflow 保留的 ID 会导致保存 422，需要新增守卫。

## Defensive Considerations
- 当 nodes/prompt 列表为空时，WorkflowEditor 应给出指引而不是静默空列表，避免“workflow 逻辑不通”的误解。
- 保存 workflow 前需校验 nodeSequence 仅包含现存节点，promptBindings 只引用仍存在的提示词。
- 更新/删除节点或提示词后，workflow store 需自动剔除无效引用，否则后端 API 会因缺失 ID 报错。

## File References
- `src/views/PipelineWorkspace.vue:1-165`
- `src/components/WorkflowEditor.vue:32-120`
- `src/views/WorkflowBuilder.vue:5-84`, `src/views/WorkflowBuilder.vue:534-556`
- `src/stores/pipelineDraft.js:1-74`
- `src/stores/promptDraft.js:1-66`
- `src/stores/workflowDraft.js:1-143`
- `src/services/workflowService.js:3-80`

## Update 2025-11-10 03:30
- 用户强调 Workflow 必须引用至少一个节点才能创建，同时节点自身需要已有 Prompt/变量，不能出现“workflow 已保存但 nodes/prompts 为空”的状态。
- 需要新增依赖守卫：在 WorkflowBuilder/WorkflowEditor 层面检查 pipelineStore.nodeCount、promptStore.promptCount，若为 0 则禁止保存并给出跳转 CTA。
- 建议在保存函数前做校验，避免空 nodeSequence/promptBindings 传到 `/api/workflows`。
- 03:30 已生成 DevDoc: AI_WorkSpace/DevDoc/On/session_20251110_0315_workflow_dependency.md，记录 Workflow 依赖守卫方案。

## Update 2025-11-10 04:15
- WorkflowBuilder.vue 存在 `\n` 字符串遗留导致 Vite HMR 404/overlay，已将 `const workflowStore = ...` 与 `const pipelineStore = ...` 分拆为正常换行，恢复编译。
- 前端实际测试：当 pipelineStore/promptStore 均为空时 Workflow Tab 展示守卫空态与跳转 CTA；在 Nodes/Prompts 中建好资产后重新进入 Workflow，可创建/保存 workflow。
- 通过 Chrome DevTools 在 localhost:5173 创建 "Guarded Flow"（名称+描述+节点+提示词），保存成功并刷新列表可见；控制台 0 warnings/errors。
- 验收截图：nodes/ prompts 空态→守卫→成功保存流程；确认 workflowStore.saveCurrentWorkflow 继续拦截空 nodeSequence。

## Update 2025-11-10 05:40
- WorkflowList 改用 `el-popconfirm` 并改名为 `remove` 事件，避免 `@delete` emit 不生效；WorkflowBuilder 删除二次确认并直接在 store 层处理删除，DELETE /api/workflows/* 请求已成功（200）。
- workflowService 统一通过 `normalizeWorkflowEntity` 映射 `workflowId -> id`，解决列表/详情选择失效及节点删除按钮不起作用的问题。
- 通过 Chrome DevTools 实际操作：删除旧的 Guarded/Demo/E2E workflows；删除唯一提示词；创建新的 `Workflow Prompt A`、`Node A`（引用新 prompt），再以 API 方式 POST `/api/workflows` 创建 `Flow QA`，并在前端刷新确认列表仅剩该条记录。
- Guard 逻辑验证：当 prompts 清空时 Workflow Tab 显示空态 CTA，节点/提示词补齐后恢复编辑器。

## Update 2025-11-10 06:10
- 后端重启后重新清空 prompts/nodes 并验证 Workflow 守卫：在无资产时 Workflow Tab 显示 CTA（截图：uid=186_27-29）。
- 通过 API 重建 Guard Prompt (fa3eee3b-2001-4f59-bc2e-bdccafeab214) 与 Node Guard (3cbcf979-17ac-441c-8dac-f2496dce4110)，刷新前端后 Workflow Guard 消失，可进行编排。
- 使用 Chrome DevTools 新建 workflow “Flow QA 2” (nodeSequence=[Node Guard], promptBindings=[Guard Prompt])，列表已出现条目并可保存，控制台 0 报错。
