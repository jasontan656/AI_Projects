# 会话记录（session_20251107_0615）

## User Intent
- 用户希望将 prompts 页面改造成与节点编排菜单一致的分阶段/卡片式交互：起始页展示“开始创建”“进入管理”等操作选项，而不是直接显示列表与新建表单。

## Repo Context
- 关键视图：`src/views/PipelineWorkspace.vue` 当前在 prompts 标签中采用 `PromptList` + `PromptEditor` 的两列布局，缺乏节点菜单式阶段控制。
- 组件：
  - `src/components/PromptList.vue`（侧边列表，直接展示并支持删除/刷新）。
  - `src/components/PromptEditor.vue`（右侧表单，提供新建/编辑按钮逻辑，内部依赖 `PromptCodeEditor`）。
  - `src/components/NodeSubMenu.vue`（节点菜单卡片列表，可复用设计语言）。
  - `src/components/NodeActionList.vue`、`src/components/NodeDraftForm.vue` 展示节点阶段在“开始创建/进入管理”的操作方式。
- 数据层：`src/stores/promptDraft.js` 使用 Pinia 管理 prompts 列表与选中项；`src/services/promptService.js` 提供 CRUD HTTP API。

## Technology Stack
- Vue 3 + Vite 前端框架。
- Element Plus 用于布局、菜单、按钮等 UI 组件。
- Pinia 用于状态管理，Vue Router/VueUse 等辅助库。

## Search Results
- Context7 `/element-plus/element-plus`：确认 Element Plus 布局组件与 display 工具类导入方式，确保新增布局时遵循现有 UI 风格。
- Exa 搜索（"Vue Flow node layout sidebar prompts UI redesign"）：
  - Vue Flow 布局示例强调依赖第三方布局库（dagre），提示保持 prompts 菜单与节点画布的空间节奏一致。
  - Node Toolbar 文档突出旁侧工具栏的卡片化交互，佐证当前节点界面“菜单→管理→Tabs”的流程合理。
- Web 搜索（Element Plus card/layout）：
  - 官方 Layout 文档（2025-11-04 抓取）提醒 24 栅格与 gutter 设置，利于 prompts 菜单使用列布局呈现 CTA 卡片。
  - Card 组件文档（2025-11-04 抓取）说明 header/body/footer、阴影控制，可直接复用卡片用于“开始创建/进入管理”入口。
  - Element Plus Study Guide（2025-09 抓取）总结卡片 slot 组合模式，可支持 prompts 菜单的定制操作区。

## Architecture Findings
- 设计差异：`PipelineWorkspace.vue` 中 `nodes` 标签拥有 `nodesStage` 状态驱动的菜单/创建/管理三段式流程，而 `prompts` 标签仅固定两列视图，未提供阶段化体验。
- 组件复用缺口：缺少 `PromptSubMenu` 类似入口组件，导致 prompts 无法呈现 CTA 卡片。
- 状态切换：当前头部 `handlePrimaryAction` 直接触发新建，缺乏与 stage 绑定的守卫逻辑（例如未保存提示词时离开警示）。
- 审美一致性：Prompts 界面仍采用旧面板，与新的节点卡片化、阴影、留白设计不匹配。

## Defensive Considerations
- Prompt 编辑未保存提示时跳转：需要与节点 `ensureCanLeaveStage` 类似的离场确认，避免误删内容。
- 切换阶段后的数据同步：进入管理视图须刷新列表；若列表为空需回退至菜单并提示创建流程。
- 删除提示词后选中态的回退处理必须与 stage 控制协同，防止界面残留旧数据。

## File References
- `src/views/PipelineWorkspace.vue:1-200` 菜单结构、stage 设置。
- `src/views/PipelineWorkspace.vue:200-360` 节点阶段逻辑与 `setNodesStage` 实现。
- `src/components/PromptList.vue:1-120` 旧式列表布局。
- `src/components/PromptEditor.vue:1-200` 表单及按钮逻辑。
- `src/stores/promptDraft.js:1-70` prompts Pinia store。
- `src/services/promptService.js:1-120` 提示词 CRUD API。

## DevDoc Output
- 已创建 AI_WorkSpace/DevDoc/On/session_20251107_0615_prompts_layout.md，总结 prompts 阶段化改造的流程、失败守卫与 GIVEN/WHEN/THEN 验收条件。
## Stack Guidance (2025-11-07)
- Vue 3 工具链 2025 年 10 月起（language-tools 3.1）将彻底移除 Vue 2 / class component 支持，必须坚持 Composition API 及 setup 语义，避免遗留选项式依赖。（来源：vuejs/language-tools 讨论 #5455，2025-06-27 公告）
- Element Plus 官方文档确认 Card 组件 2.9.8+ 提供 `header-class`/`footer-class`，并继续强调 `shadow`/`body-style` 控制卡片布局，可直接复刻节点菜单视觉。（来源：Element Plus Card 组件文档，2025-11-04 抓取）
- Pinia v3 仅支持 Vue 3，主打“boring major release”，删除 `defineStore({ id })` 等旧式 API，并要求 TypeScript 5+ / DevTools v7；Vue 2 项目需锁定 v2。（来源：Pinia v2→v3 迁移指南，2025-11-04 抓取）
## Implementation Checklist (pre-dev)
- 目标：Prompts 区域复制 nodes 菜单体验；以 `promptStage` 管理 menu/create/manage 并统一 CTA。
- 状态：activeNav、promptStage、selectedPromptId；PromptEditor 暴露 `refresh/newEntry/isDirty/syncBaseline`；PromptList 仅在 manage 渲染。
- 边界：未保存提示阻止离场；空列表禁用“进入管理”；删除当前项需 fallback；API 失败需 toast + 禁用 CTA；导航切换使用共享守卫。
- 验收：GIVEN/WHEN/THEN 约束与 devdoc 一致，涵盖未保存离场、空列表、删除回退、新建流程、禁用 CTA 等场景。

## Update 2025-11-08
### User Intent
- 用户指出 prompts 在“开始创建”阶段仍显示 `PromptEditor` 内置的“新建”按钮，交互重复且易误导；希望整个 prompts 区域的视觉与交互风格与 nodes 阶段完全统一。

### Repo Context
- `src/components/PromptEditor.vue:1-60`：表单头部永远展示“保存提示词”与“新建”两个按钮，未根据 `promptStage` 或 `isEditing` 进行条件渲染。
- `src/views/PipelineWorkspace.vue:70-180`：prompts `create` 阶段仅包裹 `PromptEditor`，没有像 nodes 那样的全宽卡片/容器，用 `.prompts-create` 简单居中，导致与 `.nodes-create` 的留白、背景不一致。
- `src/views/PipelineWorkspace.vue:200-320`：`prompts-manage` 布局为两列（列表 + 编辑器），但 header、阴影、分隔线等与 `nodesStage === 'manage'` 的样式不一致，缺乏 tabs/卡片框架。

### Technology Stack (delta)
- Element Plus 设计指南强调“Consistency”原则，需要保持组件内标题、按钮、阴影、布局一致（来源见 Search Results）。

### Search Results (2025-11-08)
- 【turn0search2】Element Plus Design Disciplines：列出 Consistency/Feedback/Efficiency/Controllability，要求界面元素在设计风格与布局上保持一致。
- 【turn0search0】Element Plus Card 组件：说明 header/body/footer 结构和 `shadow` 控制，适合复用在 prompts 菜单或管理容器以匹配 nodes 风格。

### Architecture Findings (delta)
- 交互冗余：`PromptEditor` 的“新建”按钮与 `promptStage === 'create'` 下的流程冲突，容易让用户误以为还需要再次新建，且会重置 `promptDraftStore` selection。
- 样式割裂：nodes create/manage 均通过 `.nodes-toolbar` + 卡片式容器搭配 tabs，而 prompts 仍使用老的 `.prompt-editor` 面板，造成视觉与空间节奏不统一。
- 状态错位风险：如果保留“新建”按钮，用户在 manage 阶段选中现有提示词后点击“开始创建”→进入 create；此时 editor 仍能再点击“新建”，会重置 store selection，后续 `handlePromptSaved` 路径与 stage 管控耦合，增加不可预期状态。

### Defensive Considerations
- 需根据 `promptStage` 或 `isEditing` 控制按钮显隐，避免 create 阶段触发 `newEntry` 造成 store 重置。
- 统一 toolbar/卡片容器时，要沿用 nodes 里的 `.workspace-pane--two-column`、`.nodes-toolbar` 等通用类，确保响应式断点、阴影、padding 一致。
- 在 manage 阶段合并头部布局时，应确保 `handlePromptQuickCreate` 仍然可触发 editor 新建，但按钮应位于与 nodes 相同的 header actions 区，避免多处 CTA 指向相同动作。

### File References
- `src/components/PromptEditor.vue:10-36` —— 固定按钮区。
- `src/views/PipelineWorkspace.vue:120-168` —— prompts create 阶段布局。
- `src/views/PipelineWorkspace.vue:168-220` —— prompts manage 阶段布局。

## Update 2025-11-09
### User Intent
- 用户请求评估后端 `Rise ↔ Up 对接能力报告（AI_WorkSpace/Reports/report_20251109_0149_frontend_backend_alignment.md）`，了解前后端差距、开发难度与任务量。

### Repo Context
- 报告指出 Up 前端目前仅完成节点/提示词工作台，缺乏 Workflow Builder、渠道绑定、发布/回滚、日志等视图；Rise 后端已具备 Telegram 入口、队列、workflow 执行及 Prompt/Node 契约。

### Technology Stack
- 同前（Vue 3 + Element Plus + Pinia 前端；Rise 后端含 Redis/Rabbit/Telegram gateway）。

### Search Results
- 无新增（主要依据内部报告）。

### Architecture Findings
- **核心缺口**：Workflow Builder、渠道绑定（Telegram policy）、发布/回滚流程、错误反馈、日志/可视化等。现阶段无法在前端定义 workflow 与渠道策略，只能通过后端脚本操作，阻碍可观察性与运维流程。
- **阶段建议**：报告建议 M1（Workflow CRUD + 发布）、M2（渠道绑定 + 健康检查）、M3（日志/可视化/变量工具），说明任务需跨前后端联动。

### Defensive Considerations
- 权限与发布风险：新增 Workflow/Channel UI 必须具备 Actor 鉴权与未保存守卫；回滚需有 snapshot。
- 可观察性与错误处理：需要统一 API 错误提示与 Telegram 健康灯，避免前端“静默失败”。

### File References
- `AI_WorkSpace/Reports/report_20251109_0149_frontend_backend_alignment.md`。

### DevDoc 更新
- `AI_WorkSpace/DevDoc/On/session_20251109_0149_workflow_builder.md`
- `AI_WorkSpace/DevDoc/On/session_20251109_0149_channel_binding.md`（补充 Telegram API 契约、表单校验、健康轮询、测试频率限制、GIVEN/WHEN/THEN 等细节）
- `AI_WorkSpace/DevDoc/On/session_20251109_0149_observability.md`
