---

env_policy:
  no_hardcode: true

prompts:
  enforcement: conditional
  include_mode: inline_snapshot
  embed_as: python_literal
  location:
    section: Prompts
    anchor: prompts_snapshot
  variables:
    required: []
    must_resolve: true
    sources_allowed: [env, repo, header]
  redaction:
    no_secrets_in_doc: true
    deny_patterns: [sk-*, api_key=*, token=*]

  triggers:
    section_exists: Prompts
    anchor_exists: prompts_snapshot
    fences_any_of: [yaml, json, text]
    tags_any: [ai, agent, prompt, llm]
    has_agents_spec: true
doc_contract:
  mode: python_narrative_code
  python_version: "3.11+"
  allow_inline_calls: true
  allow_chained_calls: true
  line_kinds: [def, class, import, from, for, while, if, elif, else, try, except, with, return, assign, call, read, write, error, note, source]
  layout:
    narrative_may_be_plaintext: true
    code_line_prefixes: [from, import, class, def, if, elif, else, try, except, for, while, with, return]
  narration_rules:
    import_explained: required
    def_explained: required
    call_expansion: required_1_to_2_lines
    types_cn_alias_required:
      str: 字符串
      int: 整数
      list: 列表
      dict: 字典
      Path: 路径
    function_coverage: all
  ordering:
    prefer_chinese_then_code: true
  templates:

  authoring_manifesto:
    - 文档即代码：产出必须可直译为 Python 源文件；保留真实标识符/调用/括号/赋值/类型注解与缩进。
    - 先中文后代码：先用中文解释“为什么/做什么/副作用/约束”，再给真实 import/def/调用/赋值/返回。
    - 调用要还原语义：每个关键调用后 1–2 行中文解释其隐藏的动作与副作用（call_expansion）。
    - 函数必须解释：每个 def 顶部用中文概述目的、输入/输出与副作用（def_explained）。
    - Prompt 属于代码：以 python 常量内联 PROMPT_CATALOG 与 PROMPT_VARS_SCHEMA，并锚定 prompts_snapshot。

"""文件: Kobe/WorkPlan/12.md
模块: kobe.adapters.core_strategy
同步策略: doc_is_source
目的: 统一所有渠道 Adapter 的 CoreEnvelope 构建策略；复用 13.md 中 canonical schema，避免漂移与重复维护。"""

"""导入 __future__.annotations：推迟类型注解解析，便于前向引用类型名。"""
from __future__ import annotations

"""导入 Path（路径）以表达文件/目录；从 typing 导入 Protocol/TyedDict/Mapping 表达依赖与结构。"""
from pathlib import Path
from typing import Protocol, TypedDict, Mapping, Any

"""依赖接口外形：
CoreSchemaValidator —— 校验/规范化 CoreEnvelope；Logger —— 记录 schema 警示。"""
class CoreSchemaValidator(Protocol):
    def validate(self, payload: Mapping[str, Any]) -> Mapping[str, Any]: ...
    def normalize(self, payload: Mapping[str, Any]) -> Mapping[str, Any]: ...

class Logger(Protocol):
    def warn(self, msg: str) -> None: ...
    def error(self, msg: str) -> None: ...

"""输出结构：CoreEnvelope（简化版，完整定义见 13.md schema）。"""
class CoreEnvelope(TypedDict, total=False):
    metadata: Mapping[str, Any]
    context_quotes: list[str]
    attachments: list[Mapping[str, Any]]
    ext_flags: Mapping[str, Any]
    telemetry: Mapping[str, Any]
    version: str

class SchemaValidationError(Exception):
    pass

"""函数：call_build_core_schema —— 构建统一 CoreEnvelope
MUST：
  - 使用 canonical schema（见 13.md / kobe/core/core_envelope.schema.json）校验并规范化。
  - 缺失 language → 默认 zh-CN。
  - 合并 telemetry.request_id（由中间件注入）。
失败：raise SchemaValidationError。"""
def call_build_core_schema(validator: CoreSchemaValidator, update: Mapping[str, Any], channel: str) -> CoreEnvelope:
    try:
        normalized = validator.normalize(update)  # call：统一字段形态/默认值
        checked = validator.validate(normalized)  # call：按 canonical schema 校验
    except Exception as e:  # error：SchemaValidationError
        raise SchemaValidationError(str(e))

    meta = dict(checked.get("metadata", {}))
    if not meta.get("language"):
        meta["language"] = "zh-CN"  # default：缺失语言 → zh-CN

    env: CoreEnvelope = CoreEnvelope(**checked)  # assign：回填规范化后的结构
    env["metadata"] = meta
    # 合并 telemetry.request_id（由外部中间件写入 update）
    telemetry = dict(env.get("telemetry", {}))
    if "request_id" not in telemetry and "request_id" in update:
        telemetry["request_id"] = update["request_id"]  # merge：链路追踪
    env["telemetry"] = telemetry
    env["version"] = env.get("version", "v1.0.0")
    return env

"""函数：behavior_core_envelope —— Adapter 统一行为（入站构建）
MUST：
  - Validate inbound payload against core_envelope.schema.json。
  - Normalize language；默认 zh-CN。
  - Merge telemetry.request_id。
SHOULD：
  - 提供 to_agent_request()/to_logging_dict() 帮助方法。"""
def behavior_core_envelope(validator: CoreSchemaValidator, update: Mapping[str, Any], channel: str) -> CoreEnvelope:
    return call_build_core_schema(validator, update, channel)

"""函数：call_emit_schema_alert —— 发送 schema 告警（辅助）
用于在发现渠道字段与 schema 不符时，输出结构化提示给 DevOps。"""
def call_emit_schema_alert(logger: Logger, channel: str, field: str) -> None:
    logger.warn(f"Schema mismatch on {channel}: {field}")  # log：面向运维的行动提示

"""示例（最小）：
Golden：telegram 入站 update 缺 language -> language=zh-CN；返回 version=v1.0.0。
Counter：unknown channel -> 上层拒绝（不在本函数范围）。"""
def _examples() -> None:
    return None

#@anchor:prompts_snapshot
PROMPT_CATALOG: dict = {
    "core_schema_violation": {
        "locale": "zh-CN",
        "audience": "dev",
        "text": "CoreEnvelope 校验失败: {error}",
    },
    "core_schema_alert": {
        "locale": "en-US",
        "audience": "ops",
        "text": "Schema mismatch on {channel}: {field}",
    },
}

PROMPT_VARS_SCHEMA: dict = {
    "$schema": "http://json-schema.org/draft-07/schema#",
    "type": "object",
    "properties": {
        "error": {"type": "string"},
        "channel": {"type": "string"},
        "field": {"type": "string"},
    },
    "required": [],
}

