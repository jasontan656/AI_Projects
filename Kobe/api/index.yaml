meta:
  version: "1.0"
  schema_version: "1"
  path: "Kobe/api"
  last_updated: "2025-10-15"
  owners:
    - "kobe-core"
  stability: "alpha"
module:
  name: "api"
  summary: "LangChain 聊天 API 模块，封装 FastAPI 路由与流式事件输出"
  responsibilities:
    - "构建 LangChain Agent 并根据请求动态选择模型与工具"
    - "提供 SSE 流式返回，输出进度、内容与 token 统计"
    - "定义聊天请求/响应模型并处理工具调用日志"
  non_goals:
    - "不负责底层工具实现"
    - "不处理鉴权或配额策略"
  entry_points:
    - "api.chat_langchain:router"
relations:
  depends_on:
    - "Kobe/tools"
    - "Kobe/SharedUtility/RichLogger"
  used_by:
    - "Kobe/app.py"
  provides_apis:
    - "POST /api/chat_langchain"
    - "GET /mcp/sse"
    - "GET /mcp/tools"
    - "POST /mcp/tools/call"
  reasons:
    - "集中管理聊天 API 与流式回调逻辑"
files:
  key_files:
    - "chat_langchain.py"
    - "__init__.py"
    - "bridge_logger.py"
    - "mcp_stdio_server.py"
  test_locations: []
sub_indexes: []
notes:
  - "默认模型由环境变量 OPENAI_MODEL 控制，可通过请求覆盖"
  - "依赖 tools.langchain_tools 中定义的 LangChain 工具包装"
  - "MCP SSE 入口: GET /mcp/sse, 工具列表: GET /mcp/tools, 工具调用: POST /mcp/tools/call"
  - "访问控制配置: api/mcp_access_control.yaml（通过请求头 X-Client-ID 区分客户端白名单）"
  - "Cursor 使用 stdio：.cursor/mcp.json 指向 api/mcp_stdio_server.py，配置包含 version=1、type=stdio、cwd、PYTHONIOENCODING、PYTHONPATH"
  - "Codex 使用 HTTP(SSE)：.codex/config.toml 使用 transport=sse，url=http://127.0.0.1:8000/mcp/sse"
  - "移动文件：mcp_stdio_server.py 与 mcp_access_control.yaml 已从项目根移至 api/，并同步更新所有引用路径"
