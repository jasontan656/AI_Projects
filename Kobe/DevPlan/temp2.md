# 14. 对话场景库（Brainstorm，5–10 轮/场景）

> 目的：用“用户/助手”多场景对话覆盖问好、偏航回正、澄清、检索拼接、高风险禁扩写、异常兜底等。每个场景 5–9 轮以内，便于映射到节点与键名需求。

## 场景0（完整注解：3次闲聊→回正→材料→费用→澄清）

- R1  
用户：嗨，在吗？  
助手：在～🙂 有需要我帮忙的业务吗？（可随时说）  
节点：intent=chitchat→nudger(level1); strikes=1；未触发KB。


【R1 后端动作与成本设计（研究证据版）】

目标：用最便宜的路径完成“问好”识别与回正，不调用检索，不生成长文本，控制到亚美分级别成本。

一、R1判定链路（自上而下，逐级极省）
- guard_node：检查冻结窗口（命中则直接返回暂停短信）。
- lang_detect（本地）：fastText `lid.176`/CLD3 识别语言，设置 `locale`，不调模型（<2ms）。参考实现与权威文档见 fastText、CLD3。citeturn3search0turn3search1
- intent_router（规则→小模型兜底）：
  - 规则：正则/关键词（你好/在吗/hi/hey）+长度<20字符→Greeting。
  - 含业务词（材料/费用/时限/预约…）→Business。
  - 其余→Ambiguous→调用 4o‑mini 做“结构化输出”的轻量分类（≤80 in / ≤10 out tokens）。结构化输出用 JSON Schema/`response_format.strict` 或工具 `strict:true`，保证只回 `{intent:"..."}`，稳定对齐下游。citeturn0search1turn0search2
- nudge_bank（本地）：若 Greeting/Chitchat → 直接从多语言应答库取一句短文案（不调模型）。
- state_sync：`strikes+1` 写入；无其他副作用。

二、该轮节点 I/O（最小可行）
- 输入信封：`{ctx, user:{text,channel}, state:{strikes,freeze_until_iso}}`
- lang_detect.in → `{text}`；out → `{lang:"zh", conf:0.99}`
- intent_router.in → `{text, lang}`；out → `{intent:"chitchat|business|ambiguous", conf}`
- nudger.in → `{intent, strikes}`；out → `{nudge_text, freeze:false, next_strikes}`
- 响应：`{mode:"nudge", sms:{headline:"在～🙂", bullets:["需要我直接给清单吗？"], next:"说下你的事项"}, state:{strikes}}`

三、成本与 Token（以 2025‑10‑30 官方价目为准）
- 0 模型分支：纯规则→$0。
- 小模型兜底分支：按 GPT‑4o mini 价格 $0.60/百万输入、$2.40/百万输出；若一次 80 in/10 out→约 $0.000048 + $0.000024 = $0.000072（≈7.2e‑5 美元）。若启用 Prompt Caching，复用≥1024 令牌前缀享 50% 输入折扣；但本场景输入极短，收益有限。citeturn1search4turn1search5turn0search0
- 观察与核算：用 Langfuse 记录 `input_tokens/output_tokens/cost`，并支持自定义模型价目，便于月度预算对账。citeturn4search2turn4search0

四、为什么这样（业界证据）
- 路由优先、强弱分流：LM‑Sys RouteLLM 与 NVIDIA LLM Router 实践表明，通过“弱模型处理简单请求+强模型兜底”可显著降本（报告称可至‑85%）。citeturn2search0turn2search2
- 过度上下文会放大成本：社区多例反馈默认助手/托管方案会注入大量检索上下文，导致每问 2万+ tokens 的输入成本；自行控制检索与拼接更可控。citeturn2reddit13
- 预估索引/推理开销：GraphRAG 社区为索引流程增加“预估 Token/成本”，以便决策是否继续；同理可用于我们对话侧的路由与限额。citeturn2reddit12

五、多语言与“短短信体”落地
- 多语言不靠即时翻译：R1 属闲聊/问好，统一走本地 `nudge_bank`（`i18n/nudges.{lang}.yaml`），键名如 `greeting.level1`。
- 语言检测：优先 fastText；对极短文本可结合启发式（Emoji/标点/字符集）降误判；必要才回退到小模型确认。citeturn3search0turn3search6

六、R1 执行伪码（不依赖 RAG/检索）
```
if guard(blocked): return paused_sms()
lang = fasttext.detect(user.text)
intent = rules.intent(user.text, lang)
if intent == 'ambiguous':
  intent = call_llm_4omini_structured({text:user.text})  # <= 最多一跳
if intent == 'chitchat' or intent == 'greeting':
  msg = nudge_bank.pick(lang, level=strikes+1)
  state.strikes += 1
  return sms(msg), state
```

七、度量与阈值（建议初值）
- 规则命中率 ≥80% 时，不调用 LLM；Ambiguous 比例 ≤20%。
- 单轮输入 Token P50 ≤ 50、P95 ≤ 150；单轮成本 P95 ≤ $0.0002。
- 首轮到业务的平均轮次 ≤ 3；冻结率 ≤ 2%。

八、对 R2 的衔接
- 若 R1 已 `strikes=1~3`，R2 再闲聊则水平升级 nudger 文案；若在 R2 转业务，`strikes` 清零，进入锚点/检索链。

九、落地清单（本周可完成）
- 建立 `i18n/nudges.{zh,en,fil}.yaml` 与 `policy.yaml`（阈值/词表）。
- 接入 `fastText lid.176`/CLD3；实现规则→4o‑mini 兜底分类（Structured Outputs）。citeturn3search0turn3search1turn0search1
- 接 Langfuse：记录 tokens/cost/latency；设看板与预算警戒。citeturn4search2
- R2  
用户：最近天气不错哈。  
助手：先记下🙂 要不要回到你要办的事项上？  
节点：intent=chitchat→nudger(level2); strikes=2。

- R3  
用户：讲个笑话？  
助手：为省时间，我可直接给步骤/材料清单，要不要？  
节点：intent=chitchat→nudger(level3); strikes=3。

- R4  
用户：好吧，我想办9A签证，需要哪些材料？  
助手：结论：按官方清单办。  
• 护照、照片、表格、流水[spec]  
• 其他按受理处要求[spec]  
下一步：要我给你核对表吗？  
节点：intent=business；risk=high(“材料”)→mode=kb；anchors→KB→claims；禁自由新增事实；strikes清零。

- R5  
用户：费用大概多少？  
助手：结论：以最新费表为准。  
• 签证费按类别[spec]  
• 可能有服务费[spec]  
下一步：告诉我受理地，我替你核实。  
节点：risk=high(“费用”)→mode=kb；只用claims；无精确值则“以官方为准”。

- R6  
用户：多久能办好？  
助手：需要一个关键信息。  
• 缺：受理国家/城市 或 类型  
下一步：给我其一，我马上估时限。  
节点：coverage低→mode=clarify（只问一个槽位）。

- R7  
用户：在马尼拉，旅游目的。  
助手：结论：常规受理××天[spec]。  
• 高峰期略有波动[spec]  
• 可短信提醒进度  
下一步：要不要我生成材料核对表+时间轴？  
节点：更新anchors→KB→claims→mode=kb；低风险处可轻解释。

---

## 场景1：初识与资质边界（你们是做什么的？）

用户：你们是干什么的？  
助手：结论：办理指导与材料校对。  
• 提供官方要点[spec]  
• 生成核对表与时间线  
下一步：说你的目的地+类型。

用户：能代办吗？  
助手：非官方受理处。  
• 不代收材料  
• 仅给办理指引  
下一步：要我查你城市的受理点吗？

---

## 场景2：用户直接给条件（高覆盖→直答）

用户：上海办理9A旅游，给我材料清单。  
助手：结论：按官方清单。  
• 护照、照片、表格、流水[spec]  
• 旅行证明等按受理点[spec]  
下一步：要不要PDF核对表？

用户：要，发我。  
助手：已生成核对表链接（模拟）。  
• 含可勾选项  
下一步：需我帮你预估受理时间吗？

---

## 场景3：多次偏航后回正（到冻结前一刻）

用户：在不在？  
助手：在～🙂 需要我帮你办理吗？（nudger1）  
用户：今儿心情不错。  
助手：我们聚焦在办理方案上？（nudger2）  
用户：发张表情包～  
助手：我可直接给步骤清单，要不要？（nudger3）  
用户：好，步骤说说。  
助手：结论：3步走。  
• 备材料[spec]  
• 递交并缴费[spec]  
• 审理与取证[spec]  
下一步：要我帮你核查材料缺口吗？

---

## 场景4：强合规（法规敏感→只拼接）

用户：逾期停留会怎样？  
助手：结论：按法规处理。  
• 可能罚款/限制入境[law]  
• 需按指引离境或补救[law]  
下一步：需要我给你所在国的官方指引吗？

用户：给我菲律宾的。  
助手：结论：请按当地移民局指引。  
• 先预约咨询[law]  
• 准备证件与说明[law]  
下一步：要我贴出预约入口吗？

---

## 场景5：模糊需求→澄清→再答

用户：多久出签？  
助手：需要一个关键信息。  
• 缺：签证类型或受理地  
下一步：给我其一即可。

用户：9A，马尼拉。  
助手：结论：常规××天[spec]。  
• 高峰期可能延长[spec]  
下一步：要加上缓冲日程吗？

---

## 场景6：矛盾信息→对齐后再答

用户：我是学生，想商务访问。  
助手：有一个冲突。  
• 身份：学生  
• 目的：商务  
下一步：以“商务”为准吗？或改“探亲/旅游”？

用户：以商务为准。  
助手：结论：走商务类别要件。  
• 邀请函[spec]  
• 单位证明[spec]  
下一步：要我生成商务材料清单吗？

---

## 场景7：多语切换

用户：Can we use English?  
助手：Sure. Default Chinese; can switch per message.  
用户：那还是中文吧，给我费用。  
助手：结论：以最新费表为准。  
• 基础费[spec]  
• 服务费（如适用）[spec]  
下一步：要我替你核对受理点吗？

---

## 场景8：情绪安抚+回正（低风险可轻扩写）

用户：上次被拒签，好烦。  
助手：理解你的心情。  
• 我先列关键原因项  
• 再给复核清单  
下一步：你保留了拒签信吗？

用户：有的。  
助手：结论：按拒签信逐项复核。  
• 常见：资金/行程/材料一致性[spec]  
下一步：要我生成“复核表”模板吗？

---

## 场景9：附件场景（有文档→提要）

用户：我有材料清单PDF。  
助手：可提要关键要点。  
• 我先抽材料名  
下一步：上传后，我给缺口列表。

用户：（上传）  
助手：提要完成。  
• 命中：护照、照片  
• 缺：流水、行程单  
下一步：要详细补齐说明吗？

---

## 场景10：时效紧张（急件期望管理）

用户：明天就要用，能加急吗？  
助手：结论：是否加急看受理处。  
• 部分不提供加急[spec]  
• 条件/名额有限[spec]  
下一步：要我查你受理地是否支持加急？

---

## 场景11：价格敏感与比较（不新增事实）

用户：别家说更便宜？  
助手：费用以官方费表为准。  
• 服务内容可能不同  
• 警惕非官方渠道  
下一步：把对方报价项给我，我帮你对齐口径。

---

## 场景12：渠道与预约

用户：线下还是线上递交？  
助手：结论：以受理点公告为准。  
• 部分只接受预约  
• 线上表格先填再到场  
下一步：给我城市，我贴出入口。

---

## 场景13：隐私顾虑（最小化信息）

用户：不想给个人信息，还能估吗？  
助手：可以最小估算。  
• 仅用国家与类型  
下一步：告诉我这两个，我给范围。

---

## 场景14：越界请求（非法/造假→拒绝）

用户：能帮我P一份在职证明吗？  
助手：抱歉，不能协助不合法/不真实的事项。  
• 我可提供正规模板与说明  
下一步：要合法模板吗？

---

## 场景15：传闻澄清

用户：听说现金入境多点更好批？  
助手：无此规则。  
• 审核看材料一致性与目的[spec]  
• 现金过多反增风险[law]  
下一步：要不要按你的行程做一致性核查？

---

## 场景16：办错类别风险提醒

用户：旅游单次能否顺便面试工作？  
助手：不建议。  
• 旅游签不覆盖求职/工作[law]  
• 违规有后果[law]  
下一步：如需工作目的，我给相应路径。

---

## 场景17：断网/KB不可用兜底

用户：给我9A材料清单。  
助手：（检索异常）抱歉我这边源站不稳定。  
• 不瞎编  
• 建议先给受理地  
下一步：我稍后重试并回你官方清单。

---

## 场景18：长文本求摘要→短信体压缩

用户：这段政策太长，帮我浓缩要点。  
助手：已压缩为3点。  
• 适用对象：…[spec]  
• 必备要件：…[spec]  
• 时限与注意：…[spec]  
下一步：要不要转成核对清单？

---

## 场景19：二选一澄清（只问一个槽位）

用户：菲律宾转机要签证吗？  
助手：需要一个关键信息。  
• 缺：是否出机场  
下一步：出不出？

用户：不出。  
助手：多为免签/过境免签情形[spec]。  
• 仍看国籍与航司规则[spec]  
下一步：要细化到你的国籍吗？

---

## 场景20：追问“为什么”→解释型扩写（低风险）

用户：为什么流水要最近6个月？  
助手：为了证明资金稳定与行程可行性。  
• 审核看连续性[spec]  
• 数额不必夸张  
下一步：要我给样例打码图吗？

---

## 场景21：撤销/退款范围说明

用户：我想退款可以吗？  
助手：结论：官方受理费通常不可退[spec]。  
• 服务费按协议  
下一步：要我调出你的订单条款吗？

---

## 场景22：转人工与升级

用户：我公司有10人团队要去参展。  
助手：建议转人工团队通道。  
• 批量材料检查  
• 时间线统一安排  
下一步：留个邮箱/电话，我替你安排。

---

## 场景23：对答纠错（用户指出不符）

用户：你刚才说的表格编号不对。  
助手：收到，我来更正。  
• 已以官方版本校对[spec]  
下一步：我发你正确表格链接，行吗？

---

## 场景24：会话收尾与画像补丁

用户：今天先这样。  
助手：已记下关键偏好。  
• 语言：中文  
• 目的：旅游  
下一步：下次来我直接延续进度，行吗？

---

## 场景25：分渠道限制（短信超长控制）

用户：把流程详细讲讲。  
助手：短信体给短版。  
• 准备→递交→审理  
• 细节发你长文链接  
下一步：要长版链接吗？

---

## 场景26：跨国籍差异（先澄清国籍）

用户：从日本办和从国内办有差吗？  
助手：需要一个关键信息。  
• 缺：你的国籍  
下一步：告诉我国籍，我对比差异。

---

## 场景27：多轮澄清到直答

用户：商务访问需不需要税号？  
助手：需要一个关键信息。  
• 缺：停留天数  
下一步：大约几天？

用户：7天。  
助手：结论：短期商务常见要件如下。  
• 邀请函/日程[spec]  
• 可能不需本地税号[spec]  
下一步：要我生成清单吗？

---

## 场景28：黑白名单词触发高风险

用户：能不能少交点材料？  
助手：材料清单不能减少。  
• 以官方要件为准[spec]  
下一步：我可以帮你逐项核对，是否要做？

---

## 场景29：二选一快速分流

用户：我要么办9A，要么直接办工作签。  
助手：先定目标。  
• 旅游短期→9A  
• 就业→工作签  
下一步：你更倾向哪一个？

---

## 场景30：总结复盘请求

用户：帮我回顾今天结论。  
助手：总结：你倾向9A旅游。  
• 材料：护照/照片/表格/流水[spec]  
• 费用：按最新费表[spec]  
• 时限：常规××天[spec]  
下一步：要我发“材料核对表+时间轴”吗？